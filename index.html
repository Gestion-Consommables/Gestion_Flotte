<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des Flottes - Poste Guinéenne</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Add Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2ecc71;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --dark-color: #2c3e50;
      --light-color: #ecf0f1;
      --text-color: #333;
      --text-light: #7f8c8d;
      --border-color: #ddd;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    [data-theme="dark"] {
      --primary-color: #2980b9;
      --secondary-color: #27ae60;
      --dark-color: #ecf0f1;
      --light-color: #2c3e50;
      --text-color: #ecf0f1;
      --text-light: #bdc3c7;
      --border-color: #34495e;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: var(--text-color);
      background-color: #f5f7fa;
      transition: var(--transition);
    }

    [data-theme="dark"] body {
      background-color: #1a1a1a;
    }

    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    .app-header {
      background-color: var(--dark-color);
      color: white;
      padding: 1rem 0;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
    }

    .app-header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  
    .header-logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .header-logo {
      height: 50px;
      display: flex;
      align-items: center;
      background-color: #1a3a6d;
      padding: 0 15px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .logo-text {
      text-align: center;
      line-height: 1.2;
      font-weight: bold;
      color: white;
    }
    
    .logo-main {
      font-size: 18px;
      text-transform: uppercase;
    }
    
    .logo-sub {
      font-size: 14px;
    }
    
    .logo-slogan {
      font-size: 10px;
      color: #f9c642;
      margin-top: 2px;
    }

    .app-header h1 {
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0;
    }

    .header-actions {
      display: flex;
      gap: 15px;
    }

  
    .nav-tabs {
      display: flex;
      gap: 5px;
      margin-right: 15px;
    }

    .nav-tab {
      padding: 8px 15px;
      background: none;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      color: white;
    }

    .nav-tab.active {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .nav-tab:not(.active):hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    
    .grid-layout {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 2rem;
    }

    
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: var(--transition);
    }

    [data-theme="dark"] .card {
      background-color: #252525;
    }

    .card-header {
      padding: 1rem;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-header h2 {
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-body {
      padding: 1rem;
    }

    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--text-color);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1rem;
      transition: var(--transition);
      background-color: var(--light-color);
      color: var(--text-color);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .search-box {
      position: relative;
      width: 200px;
    }

    .search-box input {
      width: 100%;
      padding: 8px 30px 8px 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }

    .search-box i {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
    }

    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background-color: #2980b9;
    }

    .btn-secondary {
      background-color: var(--secondary-color);
      color: white;
    }

    .btn-secondary:hover {
      background-color: #27ae60;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-color);
    }

    .btn-outline:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.8rem;
    }

    
    .table-responsive {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
    }

    tr:hover {
      background-color: rgba(0, 0, 0, 0.02);
    }

    [data-theme="dark"] tr:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .table-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      font-size: 0.9rem;
    }

    .pagination {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pagination button {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--primary-color);
      font-size: 1rem;
    }

    .pagination button:disabled {
      color: var(--text-light);
      cursor: not-allowed;
    }

    
    .timeline {
      position: relative;
      padding-left: 30px;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 10px;
      top: 0;
      bottom: 0;
      width: 2px;
      background-color: var(--primary-color);
    }

    .timeline-item {
      position: relative;
      padding-bottom: 20px;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -30px;
      top: 5px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: var(--primary-color);
    }

    .timeline-date {
      font-size: 0.8rem;
      color: var(--text-light);
      margin-bottom: 5px;
    }

    .timeline-content {
      background-color: var(--light-color);
      padding: 10px 15px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background-color: white;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    [data-theme="dark"] .modal-content {
      background-color: #252525;
    }

    .modal-header {
      padding: 15px 20px;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 15px 20px;
      display: flex;
      justify-content: flex-end;
      border-top: 1px solid var(--border-color);
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: white;
    }

    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--dark-color);
      color: white;
      padding: 15px 20px;
      border-radius: 4px;
      box-shadow: var(--shadow);
      transform: translateY(100px);
      opacity: 0;
      transition: var(--transition);
      z-index: 1100;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    
    .bike-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .bike-status.en-service {
      background-color: #d4edda;
      color: #155724;
    }

    .bike-status.en-panne {
      background-color: #f8d7da;
      color: #721c24;
    }

    .bike-status.en-maintenance {
      background-color: #fff3cd;
      color: #856404;
    }

    [data-theme="dark"] .bike-status.en-service {
      background-color: #155724;
      color: #d4edda;
    }

    [data-theme="dark"] .bike-status.en-panne {
      background-color: #721c24;
      color: #f8d7da;
    }

    [data-theme="dark"] .bike-status.en-maintenance {
      background-color: #856404;
      color: #fff3cd;
    }

    
    .detail-item {
      margin-bottom: 15px;
    }

    .detail-label {
      font-weight: 600;
      display: block;
      margin-bottom: 5px;
      color: var(--primary-color);
    }

    .detail-value {
      display: block;
    }

    .full-width {
      width: 100%;
    }

    .maintenance-title {
      margin: 20px 0 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid var(--border-color);
    }

    .maintenance-item {
      padding: 10px;
      margin-bottom: 10px;
      background-color: var(--light-color);
      border-radius: 4px;
    }

    .maintenance-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .maintenance-type {
      font-weight: 600;
    }

    .maintenance-date {
      color: var(--text-light);
      font-size: 0.9rem;
    }

    .maintenance-cost {
      font-weight: 500;
      margin-bottom: 5px;
    }

    .maintenance-description {
      font-size: 0.9rem;
    }

    
    .localisation-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .localisation-status.fixe {
      background-color: #e3f2fd;
      color: #1565c0;
    }

    .localisation-status.mobile {
      background-color: #e8f5e8;
      color: #2e7d32;
    }

    .localisation-status.autre-site {
      background-color: #fff3e0;
      color: #ef6c00;
    }

    [data-theme="dark"] .localisation-status.fixe {
      background-color: #0d47a1;
      color: #e3f2fd;
    }

    [data-theme="dark"] .localisation-status.mobile {
      background-color: #1b5e20;
      color: #e8f5e8;
    }

    [data-theme="dark"] .localisation-status.autre-site {
      background-color: #e65100;
      color: #fff3e0;
    }

  
    .mb-3 { margin-bottom: 1rem; }
    .mt-3 { margin-top: 1rem; }
    .text-center { text-align: center; }
    .d-flex { display: flex; }
    .align-center { align-items: center; }
    .justify-between { justify-content: space-between; }

  
    @media (max-width: 768px) {
      .app-header .container {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .header-logo-container {
        flex-direction: column;
        text-align: center;
      }
      
      .header-logo {
        margin-bottom: 10px;
      }
      
      .header-actions {
        width: 100%;
        justify-content: center;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .table-footer {
        flex-direction: column;
        gap: 15px;
      }
      
      .modal-content {
        width: 95%;
      }
    }

    @media (max-width: 480px) {
      .card-header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }
      
      .form-actions {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
      
      .nav-tabs {
        margin-right: 0;
        margin-bottom: 10px;
      }
      
      .header-logo {
        height: 40px;
        padding: 0 10px;
      }
      
      .logo-main {
        font-size: 16px;
      }
      
      .logo-sub {
        font-size: 12px;
      }
      
      .logo-slogan {
        font-size: 9px;
      }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="container">
      <div class="header-logo-container">
        <div class="header-logo">
          <div class="logo-text">
            <div class="logo-main">LA POSTE</div>
            <div class="logo-sub">GUINÉENNE</div>
            <div class="logo-slogan">Confiance - Innovation - Proximité</div>
          </div>
        </div>
        <h1><i class="fas fa-truck-moving"></i> Gestion des Flottes</h1>
      </div>
      <div class="header-actions">
        <div class="nav-tabs">
          <button class="nav-tab active" data-tab="vehicles"><i class="fas fa-car"></i> Véhicules</button>
          <button class="nav-tab" data-tab="bikes"><i class="fas fa-bicycle"></i> Motos</button>
          <button class="nav-tab" data-tab="generators"><i class="fas fa-bolt"></i> Groupes Électrogènes</button>
        </div>
        <button id="export-excel" class="btn btn-primary"><i class="fas fa-file-excel"></i> Exporter Excel</button>
        <button id="toggle-theme" class="btn btn-secondary"><i class="fas fa-moon"></i></button>
      </div>
    </div>
  </header>

  <main class="container">
    
    <div id="vehicles-tab" class="tab-content active">
      <div class="grid-layout">
        
        <section id="form-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-car"></i> Ajouter/Modifier un Véhicule</h2>
            <button id="clear-form" class="btn btn-sm btn-outline">Nouveau</button>
          </div>
          <div class="card-body">
            <form id="vehicule-form" class="form-grid">
              <div class="form-group">
                <label for="immatriculation">Immatriculation</label>
                <input type="text" id="immatriculation" placeholder="Ex: ABC1234" required />
              </div>
              
              <div class="form-group">
                <label for="marque">Marque/Modèle</label>
                <input type="text" id="marque" placeholder="Ex: Toyota Hilux" required />
              </div>
              
              <div class="form-group">
                <label for="type">Type</label>
                <select id="type" required>
                  <option value="">Sélectionner...</option>
                  <option value="voiture">Voiture</option>
                  <option value="camion">Camion</option>
                  <option value="bus">Bus</option>
                  <option value="pick-up">Pick-up</option>
                  <option value="van">Van</option>
                  <option value="fourgonette">Fourgonette</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              
              
              <div class="form-group">
                <label for="date_circulation">Date de mise en circulation</label>
                <input type="text" id="date_circulation" placeholder="JJ MM AAAA" required />
                <small style="color: var(--text-light); font-size: 0.8rem;">Format: Jour Mois Année (ex: 15 03 2020)</small>
              </div>
              
              <div class="form-group">
                <label for="statut">Statut</label>
                <select id="statut" required>
                  <option value="en service">En service</option>
                  <option value="en panne">En panne</option>
                  <option value="en maintenance">En maintenance</option>
                  <option value="hors service">Hors service</option>
                </select>
              </div>

              
              <div class="form-group">
                <label for="localisation">Localisation</label>
                <select id="localisation" required>
                  <option value="en_circulation">En circulation</option>
                  <option value="garage">Garage</option>
                  <option value="au_bureau">Au Bureau</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="chauffeur">Facteur assigné</label>
                <input type="text" id="chauffeur" placeholder="Nom et prénom du facteur" />
              </div>
              
              <div class="form-group full-width">
                <label for="observations">Observations</label>
                <textarea id="observations" placeholder="Notes sur l'état du véhicule"></textarea>
              </div>
              
              
              <div class="form-group">
                <label for="departement">Département Utilisateur</label>
                <select id="departement" required>
                  <option value="">Sélectionner...</option>
                  <option value="DG">Direction Générale (DG)</option>
                  <option value="DGA">Direction Générale Adjointe (DGA)</option>
                  <option value="DSI">Département des Systèmes d'Information (DSI)</option>
                  <option value="DSP">Direction des Services Postaux (DSP)</option>
                  <option value="DRH">Direction des Ressources Humaines (DRH)</option>
                  <option value="DPLMG">Direction du Patrimoine de la Logistique et Moyens Généraux (DPLMG)</option>
                  <option value="DSPS">Direction des Prospectives et Strategie des Projets(DPSP))</option>
                  <option value="DACQ">Direction d'Audit et Control Qualité (DACQ)</option>
                  <option value="DSJ">Direction des Services Juridiques (DSJ)</option>
                  <option value="DAF">Direction des Affaires Financières (DAF)</option>
                </select>
              </div>

              <div class="form-group">
                <label for="destination">Destination</label>
                <input type="text" id="destination" placeholder="Lieu de destination" />
              </div>

              <div class="form-group">
                <label for="motif_deplacement">Motif du Déplacement</label>
                <input type="text" id="motif_deplacement" placeholder="Raison du déplacement" />
              </div>

              <div class="form-group">
                <label for="km_avant">Kilométrage Départ</label>
                <input type="number" id="km_avant" placeholder="Kilométrage au départ" />
              </div>

              <div class="form-group">
                <label for="km_apres">Kilométrage Arrivée</label>
                <input type="number" id="km_apres" placeholder="Kilométrage à l'arrivée" />
              </div>

              <div class="form-group">
                <label for="km_parcouru">kilometrage parcouru</label>
                <input type="number" id="km_parcouru" placeholder="Calcul automatique" readonly />
              </div>
              
              <div class="form-actions full-width">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Enregistrer</button>
                <button type="button" id="cancel-edit" class="btn btn-outline">Annuler</button>
              </div>
            </form>
          </div>
        </section>

        
        <section id="carburant-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-gas-pump"></i> Ravitaillement en carburant</h2>
          </div>
          <div class="card-body">
            <form id="carburant-form" class="form-grid">
              <div class="form-group">
                <label for="carburant_vehicule">Véhicule</label>
                <select id="carburant_vehicule" required>
                  <option value="">Sélectionner un véhicule...</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="carburant_date">Date</label>
                <input type="text" id="carburant_date" placeholder="JJ MM AAAA" required />
                <small style="color: var(--text-light); font-size: 0.8rem;">Format: Jour Mois Année</small>
              </div>
              
              <div class="form-group">
                <label for="carburant_km_depart">Kilométrage Départ</label>
                <input type="number" id="carburant_km_depart" placeholder="Km au départ" required />
              </div>
              
              <div class="form-group">
                <label for="carburant_km_arrivee">Kilométrage Arrivée Station</label>
                <input type="number" id="carburant_km_arrivee" placeholder="Km à l'arrivée station" required />
              </div>
              
              <div class="form-group">
                <label for="carburant_km_parcouru">Kilométrage Parcouru (calculé)</label>
                <input type="number" id="carburant_km_parcouru" placeholder="Calcul automatique" readonly />
              </div>
              
              <div class="form-group">
                <label for="carburant_litres">Quantité Ravitaillée (L)</label>
                <input type="number" step="0.1" id="carburant_litres" placeholder="Ex: 45.5" required />
              </div>
              
              
              <div class="form-group">
                <label for="carburant_consommation_100km">Consommation sur 100 Km</label>
                <input type="number" step="0.1" id="carburant_consommation_100km" placeholder="Saisir la consommation" />
              </div>
              
              <div class="form-group">
                <label for="carburant_prix_unitaire">Prix Unitaire (GNF)</label>
                <input type="number" step="0.01" id="carburant_prix_unitaire" placeholder="Ex: 1250" required />
              </div>
              
              <div class="form-group">
                <label for="carburant_type">Type de carburant</label>
                <select id="carburant_type" required>
                  <option value="gasoil">Gasoil</option>
                  <option value="essence">Essence</option>
                  <option value="gnc">GNC</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="carburant_cout">Coût Total (calculé)</label>
                <input type="number" step="0.01" id="carburant_cout" placeholder="Calcul automatique" readonly />
              </div>
              
              <div class="form-group full-width">
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Ajouter Ravitaillement</button>
              </div>
            </form>
          </div>
        </section>

        
        <section id="vehicle-maintenance-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-tools"></i> Maintenance des Véhicules</h2>
          </div>
          <div class="card-body">
            <form id="vehicle-maintenance-form" class="form-grid">
              <div class="form-group">
                <label for="vehicle_maintenance_vehicule">Véhicule</label>
                <select id="vehicle_maintenance_vehicule" required>
                  <option value="">Sélectionner un véhicule...</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="vehicle_maintenance_date">Date</label>
                <input type="text" id="vehicle_maintenance_date" placeholder="JJ MM AAAA" required />
                <small style="color: var(--text-light); font-size: 0.8rem;">Format: Jour Mois Année</small>
              </div>
              
              <div class="form-group">
                <label for="vehicle_maintenance_type">Type de maintenance</label>
                <select id="vehicle_maintenance_type" required>
                  <option value="entretien_kilometrique">Entretien kilométrique</option>
                  <option value="freins">Freins</option>
                  <option value="pneus">Pneus</option>
                  <option value="climatisation">Climatisation</option>
                  <option value="electrique">Problème électrique</option>
                  <option value="moteur">Problème de moteur</option>
                  <option value="carrosserie">Problème de carrosserie</option>
                  <option value="suspension">Problème de suspension</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="vehicle_maintenance_cout">Coût (GNF)</label>
                <input type="number" step="0.01" id="vehicle_maintenance_cout" placeholder="Ex: 325000" required />
              </div>
              
              <div class="form-group full-width">
                <label for="vehicle_maintenance_description">Description</label>
                <textarea id="vehicle_maintenance_description" placeholder="Détails de la maintenance, pièces remplacées..."></textarea>
              </div>
              
              <div class="form-group full-width">
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Ajouter Maintenance</button>
              </div>
            </form>
          </div>
        </section>

      
        <section id="vehicules-list" class="card">
          <div class="card-header">
            <h2><i class="fas fa-list"></i> Liste des Véhicules</h2>
            <div class="search-box">
              <input type="text" id="search-vehicule" placeholder="Rechercher véhicule...">
              <i class="fas fa-search"></i>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table id="vehicules-table">
                <thead>
                  <tr>
                    <th>Immat.</th>
                    <th>Marque/Modèle</th>
                    <th>Type</th>
                    <th>Statut</th>
                    <th>Localisation</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="liste-vehicules">
                  
                </tbody>
              </table>
            </div>
            <div class="table-footer">
              <div class="table-info" id="vehicule-count">0 véhicules</div>
              <div class="pagination">
                <button id="prev-page" disabled><i class="fas fa-chevron-left"></i></button>
                <span id="page-info">Page 1</span>
                <button id="next-page" disabled><i class="fas fa-chevron-right"></i></button>
              </div>
            </div>
          </div>
        </section>

        
        <section id="historique-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-history"></i> Historique des Actions</h2>
            <div class="filter-actions">
              <select id="filter-type">
                <option value="all">Tous les types</option>
                <option value="vehicle">Véhicules</option>
                <option value="fuel">Carburant</option>
                <option value="maintenance">Maintenance</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div class="timeline" id="historique">
              
            </div>
          </div>
        </section>
      </div>
    </div>

    
    <div id="bikes-tab" class="tab-content">
      <div class="grid-layout">
        
        <section id="bike-form-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-bicycle"></i> Ajouter/Modifier une Moto</h2>
            <button id="clear-bike-form" class="btn btn-sm btn-outline">Nouveau</button>
          </div>
          <div class="card-body">
            <form id="bike-form" class="form-grid">
              <div class="form-group">
                <label for="bike_immatriculation">Immatriculation</label>
                <input type="text" id="bike_immatriculation" placeholder="Ex: MOTO1234" required />
              </div>
              
              <div class="form-group">
                <label for="bike_marque">Marque/Modèle</label>
                <input type="text" id="bike_marque" placeholder="Ex: Yamaha XTZ" required />
              </div>
              
              <div class="form-group">
                <label for="bike_type">Type</label>
                <select id="bike_type" required>
                  <option value="">Sélectionner...</option>
                  <option value="moto_cross">Moto Cross</option>
                  <option value="moto_routiere">Moto Routière</option>
                  <option value="scooter">Scooter</option>
                  <option value="tricycle">Tricycle</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              
              
              <div class="form-group">
                <label for="bike_date_circulation">Date de mise en circulation</label>
                <input type="text" id="bike_date_circulation" placeholder="JJ MM AAAA" required />
                <small style="color: var(--text-light); font-size: 0.8rem;">Format: Jour Mois Année (ex: 15 03 2020)</small>
              </div>
              
              <div class="form-group">
                <label for="bike_statut">Statut</label>
                <select id="bike_statut" required>
                  <option value="en service">En service</option>
                  <option value="en panne">En panne</option>
                  <option value="en maintenance">En maintenance</option>
                  <option value="hors service">Hors service</option>
                </select>
              </div>

              
              <div class="form-group">
                <label for="bike_localisation">Localisation</label>
                <select id="bike_localisation" required>
                  <option value="en_circulation">En Circulation</option>
                  <option value="garage">Garage</option>
                  <option value="au_bureau">Au Bureau</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="bike_chauffeur">Facteur assigné</label>
                <input type="text" id="bike_chauffeur" placeholder="Nom et prénom du facteur" />
              </div>
              
              <div class="form-group full-width">
                <label for="bike_observations">Observations</label>
                <textarea id="bike_observations" placeholder="Notes sur l'état de la moto"></textarea>
              </div>
              
              <div class="form-actions full-width">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Enregistrer</button>
                <button type="button" id="cancel-bike-edit" class="btn btn-outline">Annuler</button>
              </div>
            </form>
          </div>
        </section>

      
        <section id="bike-carburant-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-gas-pump"></i> Ravitaillement en carburant (Motos)</h2>
          </div>
          <div class="card-body">
            <form id="bike-carburant-form" class="form-grid">
              <div class="form-group">
                <label for="bike_carburant_moto">Moto</label>
                <select id="bike_carburant_moto" required>
                  <option value="">Sélectionner une moto...</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="bike_carburant_date">Date</label>
                <input type="text" id="bike_carburant_date" placeholder="JJ MM AAAA" required />
                <small style="color: var(--text-light); font-size: 0.8rem;">Format: Jour Mois Année</small>
              </div>
              
              <div class="form-group">
                <label for="bike_carburant_km_depart">Kilométrage Départ</label>
                <input type="number" id="bike_carburant_km_depart" placeholder="Km au départ" required />
              </div>
              
              <div class="form-group">
                <label for="bike_carburant_km_arrivee">Kilométrage Arrivée Station</label>
                <input type="number" id="bike_carburant_km_arrivee" placeholder="Km à l'arrivée station" required />
              </div>
              
              <div class="form-group">
                <label for="bike_carburant_km_parcouru">Kilométrage Parcouru (calculé)</label>
                <input type="number" id="bike_carburant_km_parcouru" placeholder="Calcul automatique" readonly />
              </div>
              
              <div class="form-group">
                <label for="bike_carburant_litres">Quantité Ravitaillée (L)</label>
                <input type="number" step="0.1" id="bike_carburant_litres" placeholder="Ex: 10.5" required />
              </div>
              
          
              <div class="form-group">
                <label for="bike_carburant_consommation_100km">Consommation sur 100 Km</label>
                <input type="number" step="0.1" id="bike_carburant_consommation_100km" placeholder="Saisir la consommation" />
              </div>
              
              <div class="form-group">
                <label for="bike_carburant_prix_unitaire">Prix Unitaire (GNF)</label>
                <input type="number" step="0.01" id="bike_carburant_prix_unitaire" placeholder="Ex: 1250" required />
              </div>
              
              <div class="form-group">
                <label for="bike_carburant_type">Type de carburant</label>
                <select id="bike_carburant_type" required>
                  <option value="essence">Essence</option>
                  <option value="gasoil">Gasoil</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="bike_carburant_cout">Coût Total (calculé)</label>
                <input type="number" step="0.01" id="bike_carburant_cout" placeholder="Calcul automatique" readonly />
              </div>
              
              <div class="form-group full-width">
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Ajouter Ravitaillement</button>
              </div>
            </form>
          </div>
        </section>

        
        <section id="bike-maintenance-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-tools"></i> Maintenance des Motos</h2>
          </div>
          <div class="card-body">
            <form id="bike-maintenance-form" class="form-grid">
              <div class="form-group">
                <label for="maintenance_bike">Moto</label>
                <select id="maintenance_bike" required>
                  <option value="">Sélectionner une moto...</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="maintenance_date">Date</label>
                <input type="text" id="maintenance_date" placeholder="JJ MM AAAA" required />
                <small style="color: var(--text-light); font-size: 0.8rem;">Format: Jour Mois Année</small>
              </div>
              
              <div class="form-group">
                <label for="maintenance_type">Type de maintenance</label>
                <select id="maintenance_type" required>
                  <option value="entretien_kilometrique">Entretien kilométrique</option>
                  <option value="freins">Freins</option>
                  <option value="pneus">Pneus</option>
                  <option value="electrique">Problème électrique</option>
                  <option value="moteur">Problème de moteur</option>
                  <option value="carrosserie">Problème de carrosserie</option>
                  <option value="suspension">Problème de suspension</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="maintenance_cout">Coût (GNF)</label>
                <input type="number" step="0.01" id="maintenance_cout" placeholder="Ex: 125000" required />
              </div>
              
              <div class="form-group full-width">
                <label for="maintenance_description">Description</label>
                <textarea id="maintenance_description" placeholder="Détails de la maintenance"></textarea>
              </div>
              
              <div class="form-group full-width">
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Ajouter Maintenance</button>
              </div>
            </form>
          </div>
        </section>

      
        <section id="bikes-list" class="card">
          <div class="card-header">
            <h2><i class="fas fa-list"></i> Liste des Motos</h2>
            <div class="search-box">
              <input type="text" id="search-bike" placeholder="Rechercher moto...">
              <i class="fas fa-search"></i>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table id="bikes-table">
                <thead>
                  <tr>
                    <th>Immat.</th>
                    <th>Marque/Modèle</th>
                    <th>Type</th>
                    <th>Statut</th>
                    <th>Localisation</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="liste-bikes">
                
                </tbody>
              </table>
            </div>
            <div class="table-footer">
              <div class="table-info" id="bike-count">0 motos</div>
              <div class="pagination">
                <button id="prev-bike-page" disabled><i class="fas fa-chevron-left"></i></button>
                <span id="bike-page-info">Page 1</span>
                <button id="next-bike-page" disabled><i class="fas fa-chevron-right"></i></button>
              </div>
            </div>
          </div>
        </section>

    
        <section id="bike-history-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-history"></i> Historique des Motos</h2>
            <div class="filter-actions">
              <select id="bike-filter-type">
                <option value="all">Tous les types</option>
                <option value="bike">Motos</option>
                <option value="maintenance">Maintenance</option>
                <option value="fuel">Carburant</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div class="timeline" id="bike-history">
            
            </div>
          </div>
        </section>
      </div>
    </div>


    <div id="generators-tab" class="tab-content">
      <div class="grid-layout">
        
        <section id="generator-form-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-bolt"></i> Ajouter/Modifier un Groupe Électrogène</h2>
            <button id="clear-generator-form" class="btn btn-sm btn-outline">Nouveau</button>
          </div>
          <div class="card-body">
            <form id="generator-form" class="form-grid">
              <div class="form-group">
                <label for="generator_immatriculation">Numéro d'inventaire</label>
                <input type="text" id="generator_immatriculation" placeholder="Ex: GEN001" required />
              </div>
              
              <div class="form-group">
                <label for="generator_marque">Marque/Modèle</label>
                <input type="text" id="generator_marque" placeholder="Ex: Caterpillar 500kVA" required />
              </div>
              
              <div class="form-group">
                <label for="generator_type">Type</label>
                <select id="generator_type" required>
                  <option value="">Sélectionner...</option>
                  <option value="diesel">Diesel</option>
                  <option value="essence">Essence</option>
                  <option value="gaz">Gaz</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="generator_puissance">Puissance (kVA)</label>
                <input type="number" id="generator_puissance" placeholder="Ex: 500" required />
              </div>
              
              <div class="form-group">
                <label for="generator_date_mise_service">Date de mise en service</label>
                <input type="text" id="generator_date_mise_service" placeholder="JJ MM AAAA" required />
                <small style="color: var(--text-light); font-size: 0.8rem;">Format: Jour Mois Année</small>
              </div>
              
              <div class="form-group">
                <label for="generator_statut">Statut</label>
                <select id="generator_statut" required>
                  <option value="en service">En service</option>
                  <option value="en panne">En panne</option>
                  <option value="en maintenance">En maintenance</option>
                  <option value="hors service">Hors service</option>
                </select>
              </div>

              
              <div class="form-group">
                <label for="generator_localisation">Localisation</label>
                <select id="generator_localisation" required>
                  <option value="fixe">Fixe</option>
                  <option value="mobile">Mobile</option>
                  <option value="autre-site">Affecté à un autre site temporaire</option>
                </select>
              </div>
              
              <div class="form-group full-width">
                <label for="generator_observations">Observations</label>
                <textarea id="generator_observations" placeholder="Notes sur l'état du groupe électrogène"></textarea>
              </div>
              
              <div class="form-actions full-width">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Enregistrer</button>
                <button type="button" id="cancel-generator-edit" class="btn btn-outline">Annuler</button>
              </div>
            </form>
          </div>
        </section>

  
        <section id="generator-carburant-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-gas-pump"></i> Ravitaillement Groupes Électrogènes</h2>
          </div>
          <div class="card-body">
            <form id="generator-carburant-form" class="form-grid">
              <div class="form-group">
                <label for="generator_carburant_groupe">Groupe Électrogène</label>
                <select id="generator_carburant_groupe" required>
                  <option value="">Sélectionner un groupe...</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="generator_carburant_date">Date</label>
                <input type="text" id="generator_carburant_date" placeholder="JJ MM AAAA" required />
                <small style="color: var(--text-light); font-size: 0.8rem;">Format: Jour Mois Année</small>
              </div>
              
              <div class="form-group">
                <label for="generator_carburant_quantite_ravitailler">Quantité ravitaillée (L)</label>
                <input type="number" step="0.1" id="generator_carburant_quantite_ravitailler" placeholder="Ex: 45.5" required />
              </div>
              
              <div class="form-group">
                <label for="generator_carburant_heure_marche">Heure de marche</label>
                <input type="time" id="generator_carburant_heure_marche" required />
              </div>
              
              <div class="form-group">
                <label for="generator_carburant_heure_arret">Heure d'arrêt</label>
                <input type="time" id="generator_carburant_heure_arret" required />
              </div>
              
              <!-- Champ temps de fonctionnement maintenant automatique et en lecture seule -->
              <div class="form-group">
                <label for="generator_carburant_temps_fonctionnement">Temps de fonctionnement</label>
                <input type="text" id="generator_carburant_temps_fonctionnement" placeholder="Calcul automatique" readonly />
                <small style="color: var(--text-light); font-size: 0.8rem;">Calculé automatiquement</small>
              </div>
              
              <div class="form-group">
                <label for="generator_carburant_quantite_consommee_heure">Quantité consommée par heure (L/h)</label>
                <input type="number" step="0.1" id="generator_carburant_quantite_consommee_heure" placeholder="Ex: 12.5" required />
              </div>
              
              <div class="form-group">
                <label for="generator_carburant_prix_unitaire">Prix Unitaire (GNF)</label>
                <input type="number" step="0.01" id="generator_carburant_prix_unitaire" placeholder="Ex: 1250" required />
              </div>
              
              <div class="form-group">
                <label for="generator_carburant_cout">Coût Total (calculé)</label>
                <input type="number" step="0.01" id="generator_carburant_cout" placeholder="Calcul automatique" readonly />
              </div>
              
              <div class="form-group full-width">
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Ajouter Ravitaillement</button>
              </div>
            </form>
          </div>
        </section>


        <section id="generator-maintenance-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-tools"></i> Maintenance des Groupes Électrogènes</h2>
          </div>
          <div class="card-body">
            <form id="generator-maintenance-form" class="form-grid">
              <div class="form-group">
                <label for="generator_maintenance_groupe">Groupe Électrogène</label>
                <select id="generator_maintenance_groupe" required>
                  <option value="">Sélectionner un groupe...</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="generator_maintenance_date">Date</label>
                <input type="text" id="generator_maintenance_date" placeholder="JJ MM AAAA" required />
                <small style="color: var(--text-light); font-size: 0.8rem;">Format: Jour Mois Année</small>
              </div>
              
              <div class="form-group">
                <label for="generator_maintenance_type">Type de maintenance</label>
                <select id="generator_maintenance_type" required>
                  <option value="entretien_preventif">Entretien préventif</option>
                  <option value="entretien_correctif">Entretien correctif</option>
                  <option value="changement_filtres">Changement des filtres</option>
                  <option value="vidange_huile">Vidange d'huile</option>
                  <option value="nettoyage_injecteurs">Nettoyage injecteurs</option>
                  <option value="revision_moteur">Révision moteur</option>
                  <option value="controle_electrique">Contrôle électrique</option>
                  <option value="changement_batterie">Changement batterie</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="generator_maintenance_cout">Coût (GNF)</label>
                <input type="number" step="0.01" id="generator_maintenance_cout" placeholder="Ex: 450000" required />
              </div>
              
              <div class="form-group full-width">
                <label for="generator_maintenance_description">Description</label>
                <textarea id="generator_maintenance_description" placeholder="Détails de la maintenance, pièces remplacées..."></textarea>
              </div>
              
              <div class="form-group full-width">
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Ajouter Maintenance</button>
              </div>
            </form>
          </div>
        </section>

      
        <section id="generators-list" class="card">
          <div class="card-header">
            <h2><i class="fas fa-list"></i> Liste des Groupes Électrogènes</h2>
            <div class="search-box">
              <input type="text" id="search-generator" placeholder="Rechercher groupe...">
              <i class="fas fa-search"></i>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table id="generators-table">
                <thead>
                  <tr>
                    <th>N° Inventaire</th>
                    <th>Marque/Modèle</th>
                    <th>Puissance</th>
                    <th>Type</th>
                    <th>Statut</th>
                    <th>Localisation</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="liste-generators">
                
                </tbody>
              </table>
            </div>
            <div class="table-footer">
              <div class="table-info" id="generator-count">0 groupes</div>
              <div class="pagination">
                <button id="prev-generator-page" disabled><i class="fas fa-chevron-left"></i></button>
                <span id="generator-page-info">Page 1</span>
                <button id="next-generator-page" disabled><i class="fas fa-chevron-right"></i></button>
              </div>
            </div>
          </div>
        </section>

        
        <section id="generator-history-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-history"></i> Historique des Groupes Électrogènes</h2>
            <div class="filter-actions">
              <select id="generator-filter-type">
                <option value="all">Tous les types</option>
                <option value="generator">Groupes</option>
                <option value="fuel">Carburant</option>
                <option value="maintenance">Maintenance</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div class="timeline" id="generator-history">
            
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <div id="vehicle-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Détails du Véhicule</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body" id="vehicle-details">
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline close-modal">Fermer</button>
      </div>
    </div>
  </div>

  <div id="bike-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="bike-modal-title">Détails de la Moto</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body" id="bike-details">
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline close-modal">Fermer</button>
      </div>
    </div>
  </div>

  <div id="generator-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="generator-modal-title">Détails du Groupe Électrogène</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body" id="generator-details">
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline close-modal">Fermer</button>
      </div>
    </div>
  </div>

  
  <div id="toast" class="toast"></div>

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script>
    // ============================================
    // CONFIGURATION SUPABASE
    // ============================================
    const SUPABASE_URL = 'https://cxqyjgfnelzunbbxvaiu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4cXlqZ2ZuZWx6dW5iYnh2YWl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1ODczOTksImV4cCI6MjA4MDE2MzM5OX0.Gj6HCxcIKv0o4mImP4IH2Thur5lm0QOqVMEKzY1JVxo';
    
    // Initialisation de Supabase
    let supabase;
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log("Supabase initialisé avec succès");
    } catch (error) {
      console.error("Erreur d'initialisation Supabase:", error);
      supabase = null;
    }

    // ============================================
    // VARIABLES GLOBALES ET ÉTAT
    // ============================================
    let editingVehicleId = null;
    let editingBikeId = null;
    let editingGeneratorId = null;
    let currentVehiclePage = 1;
    let currentBikePage = 1;
    let currentGeneratorPage = 1;
    const itemsPerPage = 10;
    
    // Variables locales comme fallback
    let localVehicles = JSON.parse(localStorage.getItem('local_vehicles')) || [];
    let localBikes = JSON.parse(localStorage.getItem('local_bikes')) || [];
    let localGenerators = JSON.parse(localStorage.getItem('local_generators')) || [];
    let localVehicleFuel = JSON.parse(localStorage.getItem('local_vehicle_fuel')) || [];
    let localVehicleMaintenance = JSON.parse(localStorage.getItem('local_vehicle_maintenance')) || [];
    let localBikeFuel = JSON.parse(localStorage.getItem('local_bike_fuel')) || [];
    let localBikeMaintenance = JSON.parse(localStorage.getItem('local_bike_maintenance')) || [];
    let localGeneratorFuel = JSON.parse(localStorage.getItem('local_generator_fuel')) || [];
    let localGeneratorMaintenance = JSON.parse(localStorage.getItem('local_generator_maintenance')) || [];

    // ============================================
    // FONCTIONS UTILITAIRES
    // ============================================
    
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast';
      
      if (type === 'success') {
        toast.style.backgroundColor = '#27ae60';
      } else if (type === 'error') {
        toast.style.backgroundColor = '#e74c3c';
      } else if (type === 'warning') {
        toast.style.backgroundColor = '#f39c12';
      } else {
        toast.style.backgroundColor = '#2c3e50';
      }
      
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    function formatLocalisation(localisation) {
      const localisations = {
        'garage': 'Garage',
        'en_circulation': 'En circulation',
        'au_bureau': 'Au bureau',
        'fixe': 'Fixe',
        'mobile': 'Mobile',
        'autre-site': 'Affecté à un autre site temporaire'
      };
      return localisations[localisation] || localisation;
    }

    function formatStatut(statut) {
      const statuts = {
        'en service': { class: 'en-service', text: 'En service' },
        'en panne': { class: 'en-panne', text: 'En panne' },
        'en maintenance': { class: 'en-maintenance', text: 'En maintenance' },
        'hors service': { class: 'en-panne', text: 'Hors service' }
      };
      
      const statutInfo = statuts[statut] || { class: '', text: statut };
      return `<span class="bike-status ${statutInfo.class}">${statutInfo.text}</span>`;
    }

    function formatDate(dateString) {
      if (!dateString) return 'Non spécifié';
      
      if (dateString.includes(' ')) {
        const parts = dateString.split(' ');
        if (parts.length === 3) {
          return `${parts[0]}/${parts[1]}/${parts[2]}`;
        }
      }
      return dateString;
    }

    function convertToStandardDate(dateString) {
      if (!dateString) return '';
      
      const parts = dateString.trim().split(/\s+/);
      
      if (parts.length !== 3) {
        return dateString;
      }
      
      const [day, month, year] = parts;
      return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
    }

    // ============================================
    // FONCTIONS SUPABASE POUR LES VÉHICULES
    // ============================================
    
    async function getVehicles() {
      if (!supabase) {
        console.log("Supabase non disponible, utilisation des données locales");
        return localVehicles;
      }
      
      try {
        const { data, error } = await supabase
          .from('vehicles')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) {
          console.error('Erreur Supabase, utilisation des données locales:', error);
          return localVehicles;
        }
        
        return data || [];
      } catch (error) {
        console.error('Erreur de connexion Supabase:', error);
        return localVehicles;
      }
    }

    async function addVehicle(vehicleData) {
      const vehicleForLocal = {
        ...vehicleData,
        id: 'local_' + Date.now(),
        created_at: new Date().toISOString()
      };
      
      if (!supabase) {
        localVehicles.push(vehicleForLocal);
        localStorage.setItem('local_vehicles', JSON.stringify(localVehicles));
        showToast('Véhicule sauvegardé localement (Supabase indisponible)', 'warning');
        renderVehiclesList();
        clearVehicleForm();
        addToHistory('vehicle', 'Ajout', `Véhicule ${vehicleData.immatriculation} ajouté`);
        return vehicleForLocal;
      }
      
      try {
        const supabaseData = {
          immatriculation: vehicleData.immatriculation,
          marque: vehicleData.marque,
          type: vehicleData.type,
          date_circulation: convertToStandardDate(vehicleData.date_circulation),
          statut: vehicleData.statut,
          localisation: vehicleData.localisation,
          chauffeur: vehicleData.chauffeur || null,
          observations: vehicleData.observations || null,
          departement: vehicleData.departement || null,
          destination: vehicleData.destination || null,
          motif_deplacement: vehicleData.motif_deplacement || null,
          km_avant: vehicleData.km_avant || 0,
          km_apres: vehicleData.km_apres || 0,
          km_parcouru: vehicleData.km_parcouru || 0
        };
        
        const { data, error } = await supabase
          .from('vehicles')
          .insert([supabaseData])
          .select();
        
        if (error) throw error;
        
        showToast('Véhicule ajouté avec succès (Supabase)', 'success');
        
        vehicleData.id = data[0].id;
        localVehicles.push(vehicleData);
        localStorage.setItem('local_vehicles', JSON.stringify(localVehicles));
        
        renderVehiclesList();
        clearVehicleForm();
        addToHistory('vehicle', 'Ajout', `Véhicule ${vehicleData.immatriculation} ajouté`);
        
        return data[0];
      } catch (error) {
        console.error('Erreur Supabase, sauvegarde locale:', error);
        
        localVehicles.push(vehicleForLocal);
        localStorage.setItem('local_vehicles', JSON.stringify(localVehicles));
        
        showToast('Véhicule sauvegardé localement', 'warning');
        renderVehiclesList();
        clearVehicleForm();
        
        return vehicleForLocal;
      }
    }

    async function updateVehicle(id, vehicleData) {
      // Mettre à jour localement d'abord
      const localIndex = localVehicles.findIndex(v => v.id === id);
      if (localIndex !== -1) {
        localVehicles[localIndex] = { ...localVehicles[localIndex], ...vehicleData };
        localStorage.setItem('local_vehicles', JSON.stringify(localVehicles));
      }
      
      if (!supabase || id.startsWith('local_')) {
        showToast('Véhicule mis à jour localement', 'success');
        renderVehiclesList();
        clearVehicleForm();
        addToHistory('vehicle', 'Modification', `Véhicule ${vehicleData.immatriculation} modifié`);
        return;
      }
      
      try {
        const supabaseData = {
          immatriculation: vehicleData.immatriculation,
          marque: vehicleData.marque,
          type: vehicleData.type,
          date_circulation: convertToStandardDate(vehicleData.date_circulation),
          statut: vehicleData.statut,
          localisation: vehicleData.localisation,
          chauffeur: vehicleData.chauffeur || null,
          observations: vehicleData.observations || null,
          departement: vehicleData.departement || null,
          destination: vehicleData.destination || null,
          motif_deplacement: vehicleData.motif_deplacement || null,
          km_avant: vehicleData.km_avant || 0,
          km_apres: vehicleData.km_apres || 0,
          km_parcouru: vehicleData.km_parcouru || 0
        };
        
        const { error } = await supabase
          .from('vehicles')
          .update(supabaseData)
          .eq('id', id);
        
        if (error) throw error;
        
        showToast('Véhicule mis à jour avec succès (Supabase)', 'success');
        
        renderVehiclesList();
        clearVehicleForm();
        addToHistory('vehicle', 'Modification', `Véhicule ${vehicleData.immatriculation} modifié`);
        
      } catch (error) {
        console.error('Erreur Supabase:', error);
        showToast('Véhicule mis à jour localement (Supabase indisponible)', 'warning');
        renderVehiclesList();
        clearVehicleForm();
      }
    }

    async function deleteVehicle(id) {
      if (!confirm('Êtes-vous sûr de vouloir supprimer ce véhicule?')) return;
      
      // Supprimer localement d'abord
      const vehicle = localVehicles.find(v => v.id === id);
      localVehicles = localVehicles.filter(v => v.id !== id);
      localStorage.setItem('local_vehicles', JSON.stringify(localVehicles));
      
      if (vehicle) {
        addToHistory('vehicle', 'Suppression', `Véhicule ${vehicle.immatriculation} supprimé`);
      }
      
      if (!supabase || id.startsWith('local_')) {
        showToast('Véhicule supprimé localement', 'success');
        renderVehiclesList();
        return;
      }
      
      try {
        const { error } = await supabase
          .from('vehicles')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        showToast('Véhicule supprimé avec succès (Supabase)', 'success');
      } catch (error) {
        console.error('Erreur Supabase:', error);
        showToast('Véhicule supprimé localement (Supabase indisponible)', 'warning');
      }
      
      renderVehiclesList();
    }

    async function getVehicleById(id) {
      // Chercher localement d'abord
      const localVehicle = localVehicles.find(v => v.id === id);
      if (localVehicle) return localVehicle;
      
      if (!supabase || id.startsWith('local_')) {
        return localVehicle;
      }
      
      try {
        const { data, error } = await supabase
          .from('vehicles')
          .select('*')
          .eq('id', id)
          .single();
        
        if (!error && data) return data;
      } catch (error) {
        console.error('Erreur Supabase:', error);
      }
      
      return null;
    }

    // ============================================
    // FONCTIONS SIMILAIRES POUR LES MOTOS
    // ============================================
    
    async function getBikes() {
      if (!supabase) {
        return localBikes;
      }
      
      try {
        const { data, error } = await supabase
          .from('motos')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) {
          console.error('Erreur Supabase pour les motos:', error);
          return localBikes;
        }
        
        return data || [];
      } catch (error) {
        console.error('Erreur de connexion:', error);
        return localBikes;
      }
    }

    async function addBike(bikeData) {
      const bikeForLocal = {
        ...bikeData,
        id: 'local_' + Date.now(),
        created_at: new Date().toISOString()
      };
      
      if (!supabase) {
        localBikes.push(bikeForLocal);
        localStorage.setItem('local_bikes', JSON.stringify(localBikes));
        showToast('Moto sauvegardée localement (Supabase indisponible)', 'warning');
        renderBikesList();
        clearBikeForm();
        addToHistory('bike', 'Ajout', `Moto ${bikeData.immatriculation} ajoutée`);
        return bikeForLocal;
      }
      
      try {
        const supabaseData = {
          immatriculation: bikeData.immatriculation,
          marque: bikeData.marque,
          type: bikeData.type,
          date_circulation: convertToStandardDate(bikeData.date_circulation),
          statut: bikeData.statut,
          localisation: bikeData.localisation,
          chauffeur: bikeData.chauffeur || null,
          observations: bikeData.observations || null
        };
        
        const { data, error } = await supabase
          .from('motos')
          .insert([supabaseData])
          .select();
        
        if (error) throw error;
        
        showToast('Moto ajoutée avec succès (Supabase)', 'success');
        
        bikeData.id = data[0].id;
        localBikes.push(bikeData);
        localStorage.setItem('local_bikes', JSON.stringify(localBikes));
        
        renderBikesList();
        clearBikeForm();
        addToHistory('bike', 'Ajout', `Moto ${bikeData.immatriculation} ajoutée`);
        
        return data[0];
      } catch (error) {
        console.error('Erreur Supabase, sauvegarde locale:', error);
        
        localBikes.push(bikeForLocal);
        localStorage.setItem('local_bikes', JSON.stringify(localBikes));
        
        showToast('Moto sauvegardée localement', 'warning');
        renderBikesList();
        clearBikeForm();
        
        return bikeForLocal;
      }
    }

    async function updateBike(id, bikeData) {
      const localIndex = localBikes.findIndex(b => b.id === id);
      if (localIndex !== -1) {
        localBikes[localIndex] = { ...localBikes[localIndex], ...bikeData };
        localStorage.setItem('local_bikes', JSON.stringify(localBikes));
      }
      
      if (!supabase || id.startsWith('local_')) {
        showToast('Moto mise à jour localement', 'success');
        renderBikesList();
        clearBikeForm();
        addToHistory('bike', 'Modification', `Moto ${bikeData.immatriculation} modifiée`);
        return;
      }
      
      try {
        const supabaseData = {
          immatriculation: bikeData.immatriculation,
          marque: bikeData.marque,
          type: bikeData.type,
          date_circulation: convertToStandardDate(bikeData.date_circulation),
          statut: bikeData.statut,
          localisation: bikeData.localisation,
          chauffeur: bikeData.chauffeur || null,
          observations: bikeData.observations || null
        };
        
        const { error } = await supabase
          .from('motos')
          .update(supabaseData)
          .eq('id', id);
        
        if (error) throw error;
        
        showToast('Moto mise à jour avec succès (Supabase)', 'success');
        
        renderBikesList();
        clearBikeForm();
        addToHistory('bike', 'Modification', `Moto ${bikeData.immatriculation} modifiée`);
        
      } catch (error) {
        console.error('Erreur Supabase:', error);
        showToast('Moto mise à jour localement (Supabase indisponible)', 'warning');
        renderBikesList();
        clearBikeForm();
      }
    }

    async function deleteBike(id) {
      if (!confirm('Êtes-vous sûr de vouloir supprimer cette moto?')) return;
      
      const bike = localBikes.find(b => b.id === id);
      localBikes = localBikes.filter(b => b.id !== id);
      localStorage.setItem('local_bikes', JSON.stringify(localBikes));
      
      if (bike) {
        addToHistory('bike', 'Suppression', `Moto ${bike.immatriculation} supprimée`);
      }
      
      if (!supabase || id.startsWith('local_')) {
        showToast('Moto supprimée localement', 'success');
        renderBikesList();
        return;
      }
      
      try {
        const { error } = await supabase
          .from('motos')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        showToast('Moto supprimée avec succès (Supabase)', 'success');
      } catch (error) {
        console.error('Erreur Supabase:', error);
        showToast('Moto supprimée localement (Supabase indisponible)', 'warning');
      }
      
      renderBikesList();
    }

    async function getBikeById(id) {
      const localBike = localBikes.find(b => b.id === id);
      if (localBike) return localBike;
      
      if (!supabase || id.startsWith('local_')) {
        return localBike;
      }
      
      try {
        const { data, error } = await supabase
          .from('motos')
          .select('*')
          .eq('id', id)
          .single();
        
        if (!error && data) return data;
      } catch (error) {
        console.error('Erreur Supabase:', error);
      }
      
      return null;
    }

    // ============================================
    // FONCTIONS SIMILAIRES POUR LES GROUPES ÉLECTROGÈNES
    // ============================================
    
    async function getGenerators() {
      if (!supabase) {
        return localGenerators;
      }
      
      try {
        const { data, error } = await supabase
          .from('generators')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) {
          console.error('Erreur Supabase pour les groupes:', error);
          return localGenerators;
        }
        
        return data || [];
      } catch (error) {
        console.error('Erreur de connexion:', error);
        return localGenerators;
      }
    }

    async function addGenerator(generatorData) {
      const generatorForLocal = {
        ...generatorData,
        id: 'local_' + Date.now(),
        created_at: new Date().toISOString()
      };
      
      if (!supabase) {
        localGenerators.push(generatorForLocal);
        localStorage.setItem('local_generators', JSON.stringify(localGenerators));
        showToast('Groupe électrogène sauvegardé localement (Supabase indisponible)', 'warning');
        renderGeneratorsList();
        clearGeneratorForm();
        addToHistory('generator', 'Ajout', `Groupe ${generatorData.immatriculation} ajouté`);
        return generatorForLocal;
      }
      
      try {
        const supabaseData = {
          immatriculation: generatorData.immatriculation,
          marque: generatorData.marque,
          type: generatorData.type,
          puissance: generatorData.puissance,
          date_mise_service: convertToStandardDate(generatorData.date_mise_service),
          statut: generatorData.statut,
          localisation: generatorData.localisation,
          observations: generatorData.observations || null
        };
        
        const { data, error } = await supabase
          .from('generators')
          .insert([supabaseData])
          .select();
        
        if (error) throw error;
        
        showToast('Groupe électrogène ajouté avec succès (Supabase)', 'success');
        
        generatorData.id = data[0].id;
        localGenerators.push(generatorData);
        localStorage.setItem('local_generators', JSON.stringify(localGenerators));
        
        renderGeneratorsList();
        clearGeneratorForm();
        addToHistory('generator', 'Ajout', `Groupe ${generatorData.immatriculation} ajouté`);
        
        return data[0];
      } catch (error) {
        console.error('Erreur Supabase, sauvegarde locale:', error);
        
        localGenerators.push(generatorForLocal);
        localStorage.setItem('local_generators', JSON.stringify(localGenerators));
        
        showToast('Groupe électrogène sauvegardé localement', 'warning');
        renderGeneratorsList();
        clearGeneratorForm();
        
        return generatorForLocal;
      }
    }

    async function updateGenerator(id, generatorData) {
      const localIndex = localGenerators.findIndex(g => g.id === id);
      if (localIndex !== -1) {
        localGenerators[localIndex] = { ...localGenerators[localIndex], ...generatorData };
        localStorage.setItem('local_generators', JSON.stringify(localGenerators));
      }
      
      if (!supabase || id.startsWith('local_')) {
        showToast('Groupe électrogène mis à jour localement', 'success');
        renderGeneratorsList();
        clearGeneratorForm();
        addToHistory('generator', 'Modification', `Groupe ${generatorData.immatriculation} modifié`);
        return;
      }
      
      try {
        const supabaseData = {
          immatriculation: generatorData.immatriculation,
          marque: generatorData.marque,
          type: generatorData.type,
          puissance: generatorData.puissance,
          date_mise_service: convertToStandardDate(generatorData.date_mise_service),
          statut: generatorData.statut,
          localisation: generatorData.localisation,
          observations: generatorData.observations || null
        };
        
        const { error } = await supabase
          .from('generators')
          .update(supabaseData)
          .eq('id', id);
        
        if (error) throw error;
        
        showToast('Groupe électrogène mis à jour avec succès (Supabase)', 'success');
        
        renderGeneratorsList();
        clearGeneratorForm();
        addToHistory('generator', 'Modification', `Groupe ${generatorData.immatriculation} modifié`);
        
      } catch (error) {
        console.error('Erreur Supabase:', error);
        showToast('Groupe électrogène mis à jour localement (Supabase indisponible)', 'warning');
        renderGeneratorsList();
        clearGeneratorForm();
      }
    }

    async function deleteGenerator(id) {
      if (!confirm('Êtes-vous sûr de vouloir supprimer ce groupe électrogène?')) return;
      
      const generator = localGenerators.find(g => g.id === id);
      localGenerators = localGenerators.filter(g => g.id !== id);
      localStorage.setItem('local_generators', JSON.stringify(localGenerators));
      
      if (generator) {
        addToHistory('generator', 'Suppression', `Groupe ${generator.immatriculation} supprimé`);
      }
      
      if (!supabase || id.startsWith('local_')) {
        showToast('Groupe électrogène supprimé localement', 'success');
        renderGeneratorsList();
        return;
      }
      
      try {
        const { error } = await supabase
          .from('generators')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        showToast('Groupe électrogène supprimé avec succès (Supabase)', 'success');
      } catch (error) {
        console.error('Erreur Supabase:', error);
        showToast('Groupe électrogène supprimé localement (Supabase indisponible)', 'warning');
      }
      
      renderGeneratorsList();
    }

    async function getGeneratorById(id) {
      const localGenerator = localGenerators.find(g => g.id === id);
      if (localGenerator) return localGenerator;
      
      if (!supabase || id.startsWith('local_')) {
        return localGenerator;
      }
      
      try {
        const { data, error } = await supabase
          .from('generators')
          .select('*')
          .eq('id', id)
          .single();
        
        if (!error && data) return data;
      } catch (error) {
        console.error('Erreur Supabase:', error);
      }
      
      return null;
    }

    // ============================================
    // FONCTIONS SUPABASE POUR LE CARBURANT (VÉHICULES)
    // ============================================
    
    async function addVehicleFuel(fuelData) {
      const fuelForLocal = {
        ...fuelData,
        id: 'local_fuel_' + Date.now(),
        created_at: new Date().toISOString()
      };
      
      if (!supabase) {
        localVehicleFuel.push(fuelForLocal);
        localStorage.setItem('local_vehicle_fuel', JSON.stringify(localVehicleFuel));
        showToast('Ravitaillement sauvegardé localement (Supabase indisponible)', 'warning');
        
        const vehicle = await getVehicleById(fuelData.vehicle_id);
        if (vehicle) {
          addToHistory('fuel', 'Ravitaillement', `Carburant ajouté pour ${vehicle.immatriculation}`);
        }
        
        return fuelForLocal;
      }
      
      try {
        const supabaseData = {
          vehicle_id: fuelData.vehicle_id,
          date: convertToStandardDate(fuelData.date),
          km_depart: fuelData.km_depart,
          km_arrivee: fuelData.km_arrivee,
          km_parcouru: fuelData.km_parcouru,
          litres: fuelData.litres,
          consommation_100km: fuelData.consommation_100km,
          prix_unitaire: fuelData.prix_unitaire,
          type: fuelData.type,
          cout: fuelData.cout
        };
        
        const { data, error } = await supabase
          .from('vehicle_fuel')
          .insert([supabaseData])
          .select();
        
        if (error) throw error;
        
        showToast('Ravitaillement enregistré avec succès (Supabase)', 'success');
        
        fuelData.id = data[0].id;
        localVehicleFuel.push(fuelData);
        localStorage.setItem('local_vehicle_fuel', JSON.stringify(localVehicleFuel));
        
        const vehicle = await getVehicleById(fuelData.vehicle_id);
        if (vehicle) {
          addToHistory('fuel', 'Ravitaillement', `Carburant ajouté pour ${vehicle.immatriculation}`);
        }
        
        return data[0];
      } catch (error) {
        console.error('Erreur Supabase, sauvegarde locale:', error);
        
        localVehicleFuel.push(fuelForLocal);
        localStorage.setItem('local_vehicle_fuel', JSON.stringify(localVehicleFuel));
        
        showToast('Ravitaillement sauvegardé localement', 'warning');
        
        const vehicle = await getVehicleById(fuelData.vehicle_id);
        if (vehicle) {
          addToHistory('fuel', 'Ravitaillement', `Carburant ajouté pour ${vehicle.immatriculation}`);
        }
        
        return fuelForLocal;
      }
    }

    async function getVehicleFuel() {
      if (!supabase) {
        return localVehicleFuel;
      }
      
      try {
        const { data, error } = await supabase
          .from('vehicle_fuel')
          .select('*')
          .order('date', { ascending: false });
        
        if (error) {
          console.error('Erreur Supabase pour le carburant véhicule:', error);
          return localVehicleFuel;
        }
        
        return data || [];
      } catch (error) {
        console.error('Erreur de connexion:', error);
        return localVehicleFuel;
      }
    }

    // ============================================
    // FONCTIONS SUPABASE POUR LE CARBURANT (MOTOS)
    // ============================================
    
    async function addBikeFuel(fuelData) {
      const fuelForLocal = {
        ...fuelData,
        id: 'local_bike_fuel_' + Date.now(),
        created_at: new Date().toISOString()
      };
      
      if (!supabase) {
        localBikeFuel.push(fuelForLocal);
        localStorage.setItem('local_bike_fuel', JSON.stringify(localBikeFuel));
        showToast('Ravitaillement moto sauvegardé localement (Supabase indisponible)', 'warning');
        
        const bike = await getBikeById(fuelData.bike_id);
        if (bike) {
          addToHistory('bike_fuel', 'Ravitaillement', `Carburant ajouté pour moto ${bike.immatriculation}`);
        }
        
        return fuelForLocal;
      }
      
      try {
        const supabaseData = {
          bike_id: fuelData.bike_id,
          date: convertToStandardDate(fuelData.date),
          km_depart: fuelData.km_depart,
          km_arrivee: fuelData.km_arrivee,
          km_parcouru: fuelData.km_parcouru,
          litres: fuelData.litres,
          consommation_100km: fuelData.consommation_100km,
          prix_unitaire: fuelData.prix_unitaire,
          type: fuelData.type,
          cout: fuelData.cout
        };
        
        const { data, error } = await supabase
          .from('bike_fuel')
          .insert([supabaseData])
          .select();
        
        if (error) throw error;
        
        showToast('Ravitaillement moto enregistré avec succès (Supabase)', 'success');
        
        fuelData.id = data[0].id;
        localBikeFuel.push(fuelData);
        localStorage.setItem('local_bike_fuel', JSON.stringify(localBikeFuel));
        
        const bike = await getBikeById(fuelData.bike_id);
        if (bike) {
          addToHistory('bike_fuel', 'Ravitaillement', `Carburant ajouté pour moto ${bike.immatriculation}`);
        }
        
        return data[0];
      } catch (error) {
        console.error('Erreur Supabase, sauvegarde locale:', error);
        
        localBikeFuel.push(fuelForLocal);
        localStorage.setItem('local_bike_fuel', JSON.stringify(localBikeFuel));
        
        showToast('Ravitaillement moto sauvegardé localement', 'warning');
        
        const bike = await getBikeById(fuelData.bike_id);
        if (bike) {
          addToHistory('bike_fuel', 'Ravitaillement', `Carburant ajouté pour moto ${bike.immatriculation}`);
        }
        
        return fuelForLocal;
      }
    }

    async function getBikeFuel() {
      if (!supabase) {
        return localBikeFuel;
      }
      
      try {
        const { data, error } = await supabase
          .from('bike_fuel')
          .select('*')
          .order('date', { ascending: false });
        
        if (error) {
          console.error('Erreur Supabase pour le carburant moto:', error);
          return localBikeFuel;
        }
        
        return data || [];
      } catch (error) {
        console.error('Erreur de connexion:', error);
        return localBikeFuel;
      }
    }

    // ============================================
    // FONCTIONS SUPABASE POUR LE CARBURANT (GROUPES)
    // ============================================
    
    async function addGeneratorFuel(fuelData) {
      const fuelForLocal = {
        ...fuelData,
        id: 'local_generator_fuel_' + Date.now(),
        created_at: new Date().toISOString()
      };
      
      if (!supabase) {
        localGeneratorFuel.push(fuelForLocal);
        localStorage.setItem('local_generator_fuel', JSON.stringify(localGeneratorFuel));
        showToast('Ravitaillement groupe sauvegardé localement (Supabase indisponible)', 'warning');
        
        const generator = await getGeneratorById(fuelData.generator_id);
        if (generator) {
          addToHistory('generator_fuel', 'Ravitaillement', `Carburant ajouté pour groupe ${generator.immatriculation}`);
        }
        
        return fuelForLocal;
      }
      
      try {
        const supabaseData = {
          generator_id: fuelData.generator_id,
          date: convertToStandardDate(fuelData.date),
          quantite_ravitailler: fuelData.quantite_ravitailler,
          heure_marche: fuelData.heure_marche,
          heure_arret: fuelData.heure_arret,
          temps_fonctionnement: fuelData.temps_fonctionnement,
          quantite_consommee_heure: fuelData.quantite_consommee_heure,
          prix_unitaire: fuelData.prix_unitaire,
          cout: fuelData.cout
        };
        
        const { data, error } = await supabase
          .from('generator_fuel')
          .insert([supabaseData])
          .select();
        
        if (error) throw error;
        
        showToast('Ravitaillement groupe enregistré avec succès (Supabase)', 'success');
        
        fuelData.id = data[0].id;
        localGeneratorFuel.push(fuelData);
        localStorage.setItem('local_generator_fuel', JSON.stringify(localGeneratorFuel));
        
        const generator = await getGeneratorById(fuelData.generator_id);
        if (generator) {
          addToHistory('generator_fuel', 'Ravitaillement', `Carburant ajouté pour groupe ${generator.immatriculation}`);
        }
        
        return data[0];
      } catch (error) {
        console.error('Erreur Supabase, sauvegarde locale:', error);
        
        localGeneratorFuel.push(fuelForLocal);
        localStorage.setItem('local_generator_fuel', JSON.stringify(localGeneratorFuel));
        
        showToast('Ravitaillement groupe sauvegardé localement', 'warning');
        
        const generator = await getGeneratorById(fuelData.generator_id);
        if (generator) {
          addToHistory('generator_fuel', 'Ravitaillement', `Carburant ajouté pour groupe ${generator.immatriculation}`);
        }
        
        return fuelForLocal;
      }
    }

    async function getGeneratorFuel() {
      if (!supabase) {
        return localGeneratorFuel;
      }
      
      try {
        const { data, error } = await supabase
          .from('generator_fuel')
          .select('*')
          .order('date', { ascending: false });
        
        if (error) {
          console.error('Erreur Supabase pour le carburant groupe:', error);
          return localGeneratorFuel;
        }
        
        return data || [];
      } catch (error) {
        console.error('Erreur de connexion:', error);
        return localGeneratorFuel;
      }
    }

    // ============================================
    // FONCTIONS SUPABASE POUR LA MAINTENANCE (VÉHICULES)
    // ============================================
    
    async function addVehicleMaintenance(maintenanceData) {
      const maintenanceForLocal = {
        ...maintenanceData,
        id: 'local_maintenance_' + Date.now(),
        created_at: new Date().toISOString()
      };
      
      if (!supabase) {
        localVehicleMaintenance.push(maintenanceForLocal);
        localStorage.setItem('local_vehicle_maintenance', JSON.stringify(localVehicleMaintenance));
        showToast('Maintenance sauvegardée localement (Supabase indisponible)', 'warning');
        
        const vehicle = await getVehicleById(maintenanceData.vehicle_id);
        if (vehicle) {
          addToHistory('maintenance', 'Maintenance', `Maintenance pour ${vehicle.immatriculation}`);
        }
        
        return maintenanceForLocal;
      }
      
      try {
        const supabaseData = {
          vehicle_id: maintenanceData.vehicle_id,
          date: convertToStandardDate(maintenanceData.date),
          type: maintenanceData.type,
          cout: maintenanceData.cout,
          description: maintenanceData.description || null
        };
        
        const { data, error } = await supabase
          .from('vehicle_maintenance')
          .insert([supabaseData])
          .select();
        
        if (error) throw error;
        
        showToast('Maintenance enregistrée avec succès (Supabase)', 'success');
        
        maintenanceData.id = data[0].id;
        localVehicleMaintenance.push(maintenanceData);
        localStorage.setItem('local_vehicle_maintenance', JSON.stringify(localVehicleMaintenance));
        
        const vehicle = await getVehicleById(maintenanceData.vehicle_id);
        if (vehicle) {
          addToHistory('maintenance', 'Maintenance', `Maintenance pour ${vehicle.immatriculation}`);
        }
        
        return data[0];
      } catch (error) {
        console.error('Erreur Supabase, sauvegarde locale:', error);
        
        localVehicleMaintenance.push(maintenanceForLocal);
        localStorage.setItem('local_vehicle_maintenance', JSON.stringify(localVehicleMaintenance));
        
        showToast('Maintenance sauvegardée localement', 'warning');
        
        const vehicle = await getVehicleById(maintenanceData.vehicle_id);
        if (vehicle) {
          addToHistory('maintenance', 'Maintenance', `Maintenance pour ${vehicle.immatriculation}`);
        }
        
        return maintenanceForLocal;
      }
    }

    async function getVehicleMaintenance() {
      if (!supabase) {
        return localVehicleMaintenance;
      }
      
      try {
        const { data, error } = await supabase
          .from('vehicle_maintenance')
          .select('*')
          .order('date', { ascending: false });
        
        if (error) {
          console.error('Erreur Supabase pour la maintenance véhicule:', error);
          return localVehicleMaintenance;
        }
        
        return data || [];
      } catch (error) {
        console.error('Erreur de connexion:', error);
        return localVehicleMaintenance;
      }
    }

    // ============================================
    // FONCTIONS SUPABASE POUR LA MAINTENANCE (MOTOS)
    // ============================================
    
    async function addBikeMaintenance(maintenanceData) {
      const maintenanceForLocal = {
        ...maintenanceData,
        id: 'local_bike_maintenance_' + Date.now(),
        created_at: new Date().toISOString()
      };
      
      if (!supabase) {
        localBikeMaintenance.push(maintenanceForLocal);
        localStorage.setItem('local_bike_maintenance', JSON.stringify(localBikeMaintenance));
        showToast('Maintenance moto sauvegardée localement (Supabase indisponible)', 'warning');
        
        const bike = await getBikeById(maintenanceData.bike_id);
        if (bike) {
          addToHistory('bike_maintenance', 'Maintenance', `Maintenance pour moto ${bike.immatriculation}`);
        }
        
        return maintenanceForLocal;
      }
      
      try {
        const supabaseData = {
          bike_id: maintenanceData.bike_id,
          date: convertToStandardDate(maintenanceData.date),
          type: maintenanceData.type,
          cout: maintenanceData.cout,
          description: maintenanceData.description || null
        };
        
        const { data, error } = await supabase
          .from('bike_maintenance')
          .insert([supabaseData])
          .select();
        
        if (error) throw error;
        
        showToast('Maintenance moto enregistrée avec succès (Supabase)', 'success');
        
        maintenanceData.id = data[0].id;
        localBikeMaintenance.push(maintenanceData);
        localStorage.setItem('local_bike_maintenance', JSON.stringify(localBikeMaintenance));
        
        const bike = await getBikeById(maintenanceData.bike_id);
        if (bike) {
          addToHistory('bike_maintenance', 'Maintenance', `Maintenance pour moto ${bike.immatriculation}`);
        }
        
        return data[0];
      } catch (error) {
        console.error('Erreur Supabase, sauvegarde locale:', error);
        
        localBikeMaintenance.push(maintenanceForLocal);
        localStorage.setItem('local_bike_maintenance', JSON.stringify(localBikeMaintenance));
        
        showToast('Maintenance moto sauvegardée localement', 'warning');
        
        const bike = await getBikeById(maintenanceData.bike_id);
        if (bike) {
          addToHistory('bike_maintenance', 'Maintenance', `Maintenance pour moto ${bike.immatriculation}`);
        }
        
        return maintenanceForLocal;
      }
    }

    async function getBikeMaintenance() {
      if (!supabase) {
        return localBikeMaintenance;
      }
      
      try {
        const { data, error } = await supabase
          .from('bike_maintenance')
          .select('*')
          .order('date', { ascending: false });
        
        if (error) {
          console.error('Erreur Supabase pour la maintenance moto:', error);
          return localBikeMaintenance;
        }
        
        return data || [];
      } catch (error) {
        console.error('Erreur de connexion:', error);
        return localBikeMaintenance;
      }
    }

    // ============================================
    // FONCTIONS SUPABASE POUR LA MAINTENANCE (GROUPES)
    // ============================================
    
    async function addGeneratorMaintenance(maintenanceData) {
      const maintenanceForLocal = {
        ...maintenanceData,
        id: 'local_generator_maintenance_' + Date.now(),
        created_at: new Date().toISOString()
      };
      
      if (!supabase) {
        localGeneratorMaintenance.push(maintenanceForLocal);
        localStorage.setItem('local_generator_maintenance', JSON.stringify(localGeneratorMaintenance));
        showToast('Maintenance groupe sauvegardée localement (Supabase indisponible)', 'warning');
        
        const generator = await getGeneratorById(maintenanceData.generator_id);
        if (generator) {
          addToHistory('generator_maintenance', 'Maintenance', `Maintenance pour groupe ${generator.immatriculation}`);
        }
        
        return maintenanceForLocal;
      }
      
      try {
        const supabaseData = {
          generator_id: maintenanceData.generator_id,
          date: convertToStandardDate(maintenanceData.date),
          type: maintenanceData.type,
          cout: maintenanceData.cout,
          description: maintenanceData.description || null
        };
        
        const { data, error } = await supabase
          .from('generator_maintenance')
          .insert([supabaseData])
          .select();
        
        if (error) throw error;
        
        showToast('Maintenance groupe enregistrée avec succès (Supabase)', 'success');
        
        maintenanceData.id = data[0].id;
        localGeneratorMaintenance.push(maintenanceData);
        localStorage.setItem('local_generator_maintenance', JSON.stringify(localGeneratorMaintenance));
        
        const generator = await getGeneratorById(maintenanceData.generator_id);
        if (generator) {
          addToHistory('generator_maintenance', 'Maintenance', `Maintenance pour groupe ${generator.immatriculation}`);
        }
        
        return data[0];
      } catch (error) {
        console.error('Erreur Supabase, sauvegarde locale:', error);
        
        localGeneratorMaintenance.push(maintenanceForLocal);
        localStorage.setItem('local_generator_maintenance', JSON.stringify(localGeneratorMaintenance));
        
        showToast('Maintenance groupe sauvegardée localement', 'warning');
        
        const generator = await getGeneratorById(maintenanceData.generator_id);
        if (generator) {
          addToHistory('generator_maintenance', 'Maintenance', `Maintenance pour groupe ${generator.immatriculation}`);
        }
        
        return maintenanceForLocal;
      }
    }

    async function getGeneratorMaintenance() {
      if (!supabase) {
        return localGeneratorMaintenance;
      }
      
      try {
        const { data, error } = await supabase
          .from('generator_maintenance')
          .select('*')
          .order('date', { ascending: false });
        
        if (error) {
          console.error('Erreur Supabase pour la maintenance groupe:', error);
          return localGeneratorMaintenance;
        }
        
        return data || [];
      } catch (error) {
        console.error('Erreur de connexion:', error);
        return localGeneratorMaintenance;
      }
    }

    // ============================================
    // AFFICHAGE DES VÉHICULES
    // ============================================
    
    async function renderVehiclesList() {
      const vehicles = await getVehicles();
      const searchTerm = document.getElementById('search-vehicule').value.toLowerCase();
      const tbody = document.getElementById('liste-vehicules');
      const countElement = document.getElementById('vehicule-count');
      
      const filteredVehicles = vehicles.filter(vehicle => 
        vehicle.immatriculation.toLowerCase().includes(searchTerm) ||
        (vehicle.marque && vehicle.marque.toLowerCase().includes(searchTerm)) ||
        (vehicle.type && vehicle.type.toLowerCase().includes(searchTerm))
      );
      
      const totalPages = Math.ceil(filteredVehicles.length / itemsPerPage);
      const startIndex = (currentVehiclePage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedVehicles = filteredVehicles.slice(startIndex, endIndex);
      
      document.getElementById('prev-page').disabled = currentVehiclePage <= 1;
      document.getElementById('next-page').disabled = currentVehiclePage >= totalPages;
      document.getElementById('page-info').textContent = `Page ${currentVehiclePage} sur ${totalPages > 0 ? totalPages : 1}`;
      
      let html = '';
      
      if (paginatedVehicles.length === 0) {
        html = `<tr><td colspan="6" class="text-center">Aucun véhicule trouvé</td></tr>`;
      } else {
        paginatedVehicles.forEach(vehicle => {
          html += `
            <tr>
              <td>${vehicle.immatriculation || ''}</td>
              <td>${vehicle.marque || ''}</td>
              <td>${vehicle.type || ''}</td>
              <td>${formatStatut(vehicle.statut)}</td>
              <td><span class="localisation-status ${vehicle.localisation}">${formatLocalisation(vehicle.localisation)}</span></td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="editVehicle('${vehicle.id}')">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline" onclick="viewVehicleDetails('${vehicle.id}')">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline" onclick="deleteVehicle('${vehicle.id}')">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });
      }
      
      tbody.innerHTML = html;
      countElement.textContent = `${filteredVehicles.length} véhicule(s)`;
      
      populateVehicleDropdown();
    }

    async function editVehicle(id) {
      const vehicle = await getVehicleById(id);
      if (!vehicle) return;
      
      document.getElementById('immatriculation').value = vehicle.immatriculation || '';
      document.getElementById('marque').value = vehicle.marque || '';
      document.getElementById('type').value = vehicle.type || '';
      document.getElementById('date_circulation').value = vehicle.date_circulation || '';
      document.getElementById('statut').value = vehicle.statut || 'en service';
      document.getElementById('localisation').value = vehicle.localisation || 'en_circulation';
      document.getElementById('chauffeur').value = vehicle.chauffeur || '';
      document.getElementById('observations').value = vehicle.observations || '';
      document.getElementById('departement').value = vehicle.departement || '';
      document.getElementById('destination').value = vehicle.destination || '';
      document.getElementById('motif_deplacement').value = vehicle.motif_deplacement || '';
      document.getElementById('km_avant').value = vehicle.km_avant || '';
      document.getElementById('km_apres').value = vehicle.km_apres || '';
      document.getElementById('km_parcouru').value = vehicle.km_parcouru || '';
      
      editingVehicleId = id;
      document.getElementById('vehicule-form').dataset.editingId = id;
      document.getElementById('clear-form').textContent = 'Annuler édition';
      
      document.getElementById('form-section').scrollIntoView({ behavior: 'smooth' });
    }

    async function viewVehicleDetails(id) {
      const vehicle = await getVehicleById(id);
      if (!vehicle) return;
      
      let html = `
        <div class="detail-item">
          <span class="detail-label">Immatriculation:</span>
          <span class="detail-value">${vehicle.immatriculation || ''}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Marque/Modèle:</span>
          <span class="detail-value">${vehicle.marque || ''}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Type:</span>
          <span class="detail-value">${vehicle.type || ''}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Date de mise en circulation:</span>
          <span class="detail-value">${formatDate(vehicle.date_circulation)}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Statut:</span>
          <span class="detail-value">${formatStatut(vehicle.statut)}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Localisation:</span>
          <span class="detail-value">${formatLocalisation(vehicle.localisation)}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Facteur assigné:</span>
          <span class="detail-value">${vehicle.chauffeur || 'Non assigné'}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Département:</span>
          <span class="detail-value">${vehicle.departement || 'Non spécifié'}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Destination:</span>
          <span class="detail-value">${vehicle.destination || 'Non spécifiée'}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Motif du déplacement:</span>
          <span class="detail-value">${vehicle.motif_deplacement || 'Non spécifié'}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Kilométrage parcouru:</span>
          <span class="detail-value">${vehicle.km_parcouru || 0} km</span>
        </div>
      `;
      
      if (vehicle.observations) {
        html += `
          <div class="detail-item">
            <span class="detail-label">Observations:</span>
            <span class="detail-value">${vehicle.observations}</span>
          </div>
        `;
      }
      
      document.getElementById('vehicle-details').innerHTML = html;
      document.getElementById('modal-title').textContent = `Détails - ${vehicle.immatriculation || ''}`;
      document.getElementById('vehicle-modal').classList.add('show');
    }

    function clearVehicleForm() {
      document.getElementById('vehicule-form').reset();
      editingVehicleId = null;
      delete document.getElementById('vehicule-form').dataset.editingId;
      document.getElementById('clear-form').textContent = 'Nouveau';
      document.getElementById('km_parcouru').value = '';
    }

    async function populateVehicleDropdown() {
      const vehicles = await getVehicles();
      const carburantDropdown = document.getElementById('carburant_vehicule');
      const maintenanceDropdown = document.getElementById('vehicle_maintenance_vehicule');
      
      let carburantOptions = '<option value="">Sélectionner un véhicule...</option>';
      let maintenanceOptions = '<option value="">Sélectionner un véhicule...</option>';
      
      vehicles.forEach(vehicle => {
        carburantOptions += `<option value="${vehicle.id}">${vehicle.immatriculation} - ${vehicle.marque}</option>`;
        maintenanceOptions += `<option value="${vehicle.id}">${vehicle.immatriculation} - ${vehicle.marque}</option>`;
      });
      
      carburantDropdown.innerHTML = carburantOptions;
      maintenanceDropdown.innerHTML = maintenanceOptions;
    }

    // ============================================
    // AFFICHAGE DES MOTOS
    // ============================================
    
    async function renderBikesList() {
      const bikes = await getBikes();
      const searchTerm = document.getElementById('search-bike').value.toLowerCase();
      const tbody = document.getElementById('liste-bikes');
      const countElement = document.getElementById('bike-count');
      
      const filteredBikes = bikes.filter(bike => 
        bike.immatriculation.toLowerCase().includes(searchTerm) ||
        (bike.marque && bike.marque.toLowerCase().includes(searchTerm)) ||
        (bike.type && bike.type.toLowerCase().includes(searchTerm))
      );
      
      const totalPages = Math.ceil(filteredBikes.length / itemsPerPage);
      const startIndex = (currentBikePage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedBikes = filteredBikes.slice(startIndex, endIndex);
      
      document.getElementById('prev-bike-page').disabled = currentBikePage <= 1;
      document.getElementById('next-bike-page').disabled = currentBikePage >= totalPages;
      document.getElementById('bike-page-info').textContent = `Page ${currentBikePage} sur ${totalPages > 0 ? totalPages : 1}`;
      
      let html = '';
      
      if (paginatedBikes.length === 0) {
        html = `<tr><td colspan="6" class="text-center">Aucune moto trouvée</td></tr>`;
      } else {
        paginatedBikes.forEach(bike => {
          html += `
            <tr>
              <td>${bike.immatriculation || ''}</td>
              <td>${bike.marque || ''}</td>
              <td>${bike.type || ''}</td>
              <td>${formatStatut(bike.statut)}</td>
              <td><span class="localisation-status ${bike.localisation}">${formatLocalisation(bike.localisation)}</span></td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="editBike('${bike.id}')">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline" onclick="viewBikeDetails('${bike.id}')">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline" onclick="deleteBike('${bike.id}')">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });
      }
      
      tbody.innerHTML = html;
      countElement.textContent = `${filteredBikes.length} moto(s)`;
      
      populateBikeDropdown();
    }

    async function editBike(id) {
      const bike = await getBikeById(id);
      if (!bike) return;
      
      document.getElementById('bike_immatriculation').value = bike.immatriculation || '';
      document.getElementById('bike_marque').value = bike.marque || '';
      document.getElementById('bike_type').value = bike.type || '';
      document.getElementById('bike_date_circulation').value = bike.date_circulation || '';
      document.getElementById('bike_statut').value = bike.statut || 'en service';
      document.getElementById('bike_localisation').value = bike.localisation || 'en_circulation';
      document.getElementById('bike_chauffeur').value = bike.chauffeur || '';
      document.getElementById('bike_observations').value = bike.observations || '';
      
      editingBikeId = id;
      document.getElementById('bike-form').dataset.editingId = id;
      document.getElementById('clear-bike-form').textContent = 'Annuler édition';
      
      document.getElementById('bike-form-section').scrollIntoView({ behavior: 'smooth' });
    }

    async function viewBikeDetails(id) {
      const bike = await getBikeById(id);
      if (!bike) return;
      
      let html = `
        <div class="detail-item">
          <span class="detail-label">Immatriculation:</span>
          <span class="detail-value">${bike.immatriculation || ''}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Marque/Modèle:</span>
          <span class="detail-value">${bike.marque || ''}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Type:</span>
          <span class="detail-value">${bike.type || ''}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Date de mise en circulation:</span>
          <span class="detail-value">${formatDate(bike.date_circulation)}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Statut:</span>
          <span class="detail-value">${formatStatut(bike.statut)}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Localisation:</span>
          <span class="detail-value">${formatLocalisation(bike.localisation)}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Facteur assigné:</span>
          <span class="detail-value">${bike.chauffeur || 'Non assigné'}</span>
        </div>
      `;
      
      if (bike.observations) {
        html += `
          <div class="detail-item">
            <span class="detail-label">Observations:</span>
            <span class="detail-value">${bike.observations}</span>
          </div>
        `;
      }
      
      document.getElementById('bike-details').innerHTML = html;
      document.getElementById('bike-modal-title').textContent = `Détails - ${bike.immatriculation || ''}`;
      document.getElementById('bike-modal').classList.add('show');
    }

    function clearBikeForm() {
      document.getElementById('bike-form').reset();
      editingBikeId = null;
      delete document.getElementById('bike-form').dataset.editingId;
      document.getElementById('clear-bike-form').textContent = 'Nouveau';
    }

    async function populateBikeDropdown() {
      const bikes = await getBikes();
      const carburantDropdown = document.getElementById('bike_carburant_moto');
      const maintenanceDropdown = document.getElementById('maintenance_bike');
      
      let carburantOptions = '<option value="">Sélectionner une moto...</option>';
      let maintenanceOptions = '<option value="">Sélectionner une moto...</option>';
      
      bikes.forEach(bike => {
        carburantOptions += `<option value="${bike.id}">${bike.immatriculation} - ${bike.marque}</option>`;
        maintenanceOptions += `<option value="${bike.id}">${bike.immatriculation} - ${bike.marque}</option>`;
      });
      
      carburantDropdown.innerHTML = carburantOptions;
      maintenanceDropdown.innerHTML = maintenanceOptions;
    }

    // ============================================
    // AFFICHAGE DES GROUPES ÉLECTROGÈNES
    // ============================================
    
    async function renderGeneratorsList() {
      const generators = await getGenerators();
      const searchTerm = document.getElementById('search-generator').value.toLowerCase();
      const tbody = document.getElementById('liste-generators');
      const countElement = document.getElementById('generator-count');
      
      const filteredGenerators = generators.filter(generator => 
        generator.immatriculation.toLowerCase().includes(searchTerm) ||
        (generator.marque && generator.marque.toLowerCase().includes(searchTerm)) ||
        (generator.type && generator.type.toLowerCase().includes(searchTerm))
      );
      
      const totalPages = Math.ceil(filteredGenerators.length / itemsPerPage);
      const startIndex = (currentGeneratorPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedGenerators = filteredGenerators.slice(startIndex, endIndex);
      
      document.getElementById('prev-generator-page').disabled = currentGeneratorPage <= 1;
      document.getElementById('next-generator-page').disabled = currentGeneratorPage >= totalPages;
      document.getElementById('generator-page-info').textContent = `Page ${currentGeneratorPage} sur ${totalPages > 0 ? totalPages : 1}`;
      
      let html = '';
      
      if (paginatedGenerators.length === 0) {
        html = `<tr><td colspan="7" class="text-center">Aucun groupe électrogène trouvé</td></tr>`;
      } else {
        paginatedGenerators.forEach(generator => {
          html += `
            <tr>
              <td>${generator.immatriculation || ''}</td>
              <td>${generator.marque || ''}</td>
              <td>${generator.puissance || ''} kVA</td>
              <td>${generator.type || ''}</td>
              <td>${formatStatut(generator.statut)}</td>
              <td><span class="localisation-status ${generator.localisation}">${formatLocalisation(generator.localisation)}</span></td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="editGenerator('${generator.id}')">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline" onclick="viewGeneratorDetails('${generator.id}')">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline" onclick="deleteGenerator('${generator.id}')">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });
      }
      
      tbody.innerHTML = html;
      countElement.textContent = `${filteredGenerators.length} groupe(s)`;
      
      populateGeneratorDropdown();
    }

    async function editGenerator(id) {
      const generator = await getGeneratorById(id);
      if (!generator) return;
      
      document.getElementById('generator_immatriculation').value = generator.immatriculation || '';
      document.getElementById('generator_marque').value = generator.marque || '';
      document.getElementById('generator_type').value = generator.type || '';
      document.getElementById('generator_puissance').value = generator.puissance || '';
      document.getElementById('generator_date_mise_service').value = generator.date_mise_service || '';
      document.getElementById('generator_statut').value = generator.statut || 'en service';
      document.getElementById('generator_localisation').value = generator.localisation || 'fixe';
      document.getElementById('generator_observations').value = generator.observations || '';
      
      editingGeneratorId = id;
      document.getElementById('generator-form').dataset.editingId = id;
      document.getElementById('clear-generator-form').textContent = 'Annuler édition';
      
      document.getElementById('generator-form-section').scrollIntoView({ behavior: 'smooth' });
    }

    async function viewGeneratorDetails(id) {
      const generator = await getGeneratorById(id);
      if (!generator) return;
      
      let html = `
        <div class="detail-item">
          <span class="detail-label">Numéro d'inventaire:</span>
          <span class="detail-value">${generator.immatriculation || ''}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Marque/Modèle:</span>
          <span class="detail-value">${generator.marque || ''}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Type:</span>
          <span class="detail-value">${generator.type || ''}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Puissance:</span>
          <span class="detail-value">${generator.puissance || ''} kVA</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Date de mise en service:</span>
          <span class="detail-value">${formatDate(generator.date_mise_service)}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Statut:</span>
          <span class="detail-value">${formatStatut(generator.statut)}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Localisation:</span>
          <span class="detail-value">${formatLocalisation(generator.localisation)}</span>
        </div>
      `;
      
      if (generator.observations) {
        html += `
          <div class="detail-item">
            <span class="detail-label">Observations:</span>
            <span class="detail-value">${generator.observations}</span>
          </div>
        `;
      }
      
      document.getElementById('generator-details').innerHTML = html;
      document.getElementById('generator-modal-title').textContent = `Détails - ${generator.immatriculation || ''}`;
      document.getElementById('generator-modal').classList.add('show');
    }

    function clearGeneratorForm() {
      document.getElementById('generator-form').reset();
      editingGeneratorId = null;
      delete document.getElementById('generator-form').dataset.editingId;
      document.getElementById('clear-generator-form').textContent = 'Nouveau';
    }

    async function populateGeneratorDropdown() {
      const generators = await getGenerators();
      const carburantDropdown = document.getElementById('generator_carburant_groupe');
      const maintenanceDropdown = document.getElementById('generator_maintenance_groupe');
      
      let carburantOptions = '<option value="">Sélectionner un groupe...</option>';
      let maintenanceOptions = '<option value="">Sélectionner un groupe...</option>';
      
      generators.forEach(generator => {
        carburantOptions += `<option value="${generator.id}">${generator.immatriculation} - ${generator.marque}</option>`;
        maintenanceOptions += `<option value="${generator.id}">${generator.immatriculation} - ${generator.marque}</option>`;
      });
      
      carburantDropdown.innerHTML = carburantOptions;
      maintenanceDropdown.innerHTML = maintenanceOptions;
    }

    // ============================================
    // GESTION DE L'HISTORIQUE
    // ============================================
    
    function addToHistory(type, action, description) {
      const history = JSON.parse(localStorage.getItem('fleet_history') || '[]');
      const entry = {
        id: Date.now(),
        type: type,
        action: action,
        description: description,
        date: new Date().toISOString()
      };
      
      history.unshift(entry);
      if (history.length > 50) history.pop();
      
      localStorage.setItem('fleet_history', JSON.stringify(history));
      renderHistory();
    }

    function renderHistory() {
      const history = JSON.parse(localStorage.getItem('fleet_history') || '[]');
      const filterType = document.getElementById('filter-type').value;
      const timeline = document.getElementById('historique');
      
      let filteredHistory = history;
      if (filterType !== 'all') {
        filteredHistory = history.filter(entry => entry.type === filterType);
      }
      
      let html = '';
      
      if (filteredHistory.length === 0) {
        html = '<p class="text-center">Aucun historique disponible</p>';
      } else {
        filteredHistory.forEach(entry => {
          const date = new Date(entry.date);
          const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
          
          html += `
            <div class="timeline-item">
              <div class="timeline-date">${formattedDate}</div>
              <div class="timeline-content">
                <strong>${entry.action}</strong> - ${entry.description}
              </div>
            </div>
          `;
        });
      }
      
      timeline.innerHTML = html;
    }

    // ============================================
    // CALCULS AUTOMATIQUES
    // ============================================
    
    function setupAutoCalculations() {
      // Calcul kilométrage parcouru pour les véhicules
      const kmAvant = document.getElementById('km_avant');
      const kmApres = document.getElementById('km_apres');
      const kmParcouru = document.getElementById('km_parcouru');
      
      function calculateKMParcouru() {
        const avant = parseInt(kmAvant.value) || 0;
        const apres = parseInt(kmApres.value) || 0;
        kmParcouru.value = Math.max(0, apres - avant);
      }
      
      if (kmAvant && kmApres && kmParcouru) {
        kmAvant.addEventListener('input', calculateKMParcouru);
        kmApres.addEventListener('input', calculateKMParcouru);
      }
      
      // Calcul kilométrage pour le carburant des véhicules
      const carburantKmDepart = document.getElementById('carburant_km_depart');
      const carburantKmArrivee = document.getElementById('carburant_km_arrivee');
      const carburantKmParcouru = document.getElementById('carburant_km_parcouru');
      
      function calculateCarburantKMParcouru() {
        const depart = parseInt(carburantKmDepart.value) || 0;
        const arrivee = parseInt(carburantKmArrivee.value) || 0;
        carburantKmParcouru.value = Math.max(0, arrivee - depart);
      }
      
      if (carburantKmDepart && carburantKmArrivee && carburantKmParcouru) {
        carburantKmDepart.addEventListener('input', calculateCarburantKMParcouru);
        carburantKmArrivee.addEventListener('input', calculateCarburantKMParcouru);
      }
      
      // Calcul coût total pour le carburant des véhicules
      const carburantLitres = document.getElementById('carburant_litres');
      const carburantPrix = document.getElementById('carburant_prix_unitaire');
      const carburantCout = document.getElementById('carburant_cout');
      
      function calculateCarburantCout() {
        const litres = parseFloat(carburantLitres.value) || 0;
        const prix = parseFloat(carburantPrix.value) || 0;
        carburantCout.value = (litres * prix).toFixed(2);
      }
      
      if (carburantLitres && carburantPrix && carburantCout) {
        carburantLitres.addEventListener('input', calculateCarburantCout);
        carburantPrix.addEventListener('input', calculateCarburantCout);
      }
      
      // Calcul kilométrage pour les motos
      const bikeCarburantKmDepart = document.getElementById('bike_carburant_km_depart');
      const bikeCarburantKmArrivee = document.getElementById('bike_carburant_km_arrivee');
      const bikeCarburantKmParcouru = document.getElementById('bike_carburant_km_parcouru');
      
      function calculateBikeCarburantKMParcouru() {
        const depart = parseInt(bikeCarburantKmDepart.value) || 0;
        const arrivee = parseInt(bikeCarburantKmArrivee.value) || 0;
        bikeCarburantKmParcouru.value = Math.max(0, arrivee - depart);
      }
      
      if (bikeCarburantKmDepart && bikeCarburantKmArrivee && bikeCarburantKmParcouru) {
        bikeCarburantKmDepart.addEventListener('input', calculateBikeCarburantKMParcouru);
        bikeCarburantKmArrivee.addEventListener('input', calculateBikeCarburantKMParcouru);
      }
      
      // Calcul coût total pour le carburant des motos
      const bikeCarburantLitres = document.getElementById('bike_carburant_litres');
      const bikeCarburantPrix = document.getElementById('bike_carburant_prix_unitaire');
      const bikeCarburantCout = document.getElementById('bike_carburant_cout');
      
      function calculateBikeCarburantCout() {
        const litres = parseFloat(bikeCarburantLitres.value) || 0;
        const prix = parseFloat(bikeCarburantPrix.value) || 0;
        bikeCarburantCout.value = (litres * prix).toFixed(2);
      }
      
      if (bikeCarburantLitres && bikeCarburantPrix && bikeCarburantCout) {
        bikeCarburantLitres.addEventListener('input', calculateBikeCarburantCout);
        bikeCarburantPrix.addEventListener('input', calculateBikeCarburantCout);
      }
      
      // Calcul coût total pour le carburant des groupes
      const generatorCarburantQuantite = document.getElementById('generator_carburant_quantite_ravitailler');
      const generatorCarburantPrix = document.getElementById('generator_carburant_prix_unitaire');
      const generatorCarburantCout = document.getElementById('generator_carburant_cout');
      
      function calculateGeneratorCarburantCout() {
        const quantite = parseFloat(generatorCarburantQuantite.value) || 0;
        const prix = parseFloat(generatorCarburantPrix.value) || 0;
        generatorCarburantCout.value = (quantite * prix).toFixed(2);
      }
      
      if (generatorCarburantQuantite && generatorCarburantPrix && generatorCarburantCout) {
        generatorCarburantQuantite.addEventListener('input', calculateGeneratorCarburantCout);
        generatorCarburantPrix.addEventListener('input', calculateGeneratorCarburantCout);
      }
      
      // Calcul temps de fonctionnement pour les groupes électrogènes
      const heureMarche = document.getElementById('generator_carburant_heure_marche');
      const heureArret = document.getElementById('generator_carburant_heure_arret');
      const tempsFonctionnement = document.getElementById('generator_carburant_temps_fonctionnement');
      
      function calculateTempsFonctionnement() {
        if (heureMarche.value && heureArret.value) {
          const [startHours, startMinutes] = heureMarche.value.split(':').map(Number);
          const [endHours, endMinutes] = heureArret.value.split(':').map(Number);
          
          let totalMinutes = (endHours * 60 + endMinutes) - (startHours * 60 + startMinutes);
          
          if (totalMinutes < 0) {
            totalMinutes += 24 * 60;
          }
          
          const hours = Math.floor(totalMinutes / 60);
          const minutes = totalMinutes % 60;
          
          tempsFonctionnement.value = `${hours}h ${minutes}min`;
        }
      }
      
      if (heureMarche && heureArret && tempsFonctionnement) {
        heureMarche.addEventListener('input', calculateTempsFonctionnement);
        heureArret.addEventListener('input', calculateTempsFonctionnement);
      }
    }

    // ============================================
    // GESTION DES ÉVÉNEMENTS
    // ============================================
    
    function initApp() {
      console.log("Initialisation de l'application...");
      
      // Restaurer le thème
      const savedTheme = localStorage.getItem('fleet_theme') || '';
      if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
        const themeButton = document.getElementById('toggle-theme');
        themeButton.innerHTML = savedTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
      }
      
      // Gestion des onglets
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          tab.classList.add('active');
          const tabId = tab.getAttribute('data-tab') + '-tab';
          document.getElementById(tabId).classList.add('active');
        });
      });
      
      // Bouton thème
      document.getElementById('toggle-theme').addEventListener('click', function() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? '' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        this.innerHTML = newTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        localStorage.setItem('fleet_theme', newTheme);
      });
      
      // Boutons formulaire véhicule
      document.getElementById('clear-form').addEventListener('click', clearVehicleForm);
      document.getElementById('cancel-edit').addEventListener('click', clearVehicleForm);
      
      // Boutons formulaire moto
      document.getElementById('clear-bike-form').addEventListener('click', clearBikeForm);
      document.getElementById('cancel-bike-edit').addEventListener('click', clearBikeForm);
      
      // Boutons formulaire groupe
      document.getElementById('clear-generator-form').addEventListener('click', clearGeneratorForm);
      document.getElementById('cancel-generator-edit').addEventListener('click', clearGeneratorForm);
      
      // Recherche
      document.getElementById('search-vehicule').addEventListener('input', renderVehiclesList);
      document.getElementById('search-bike').addEventListener('input', renderBikesList);
      document.getElementById('search-generator').addEventListener('input', renderGeneratorsList);
      
      // Pagination véhicules
      document.getElementById('prev-page').addEventListener('click', () => {
        if (currentVehiclePage > 1) {
          currentVehiclePage--;
          renderVehiclesList();
        }
      });
      
      document.getElementById('next-page').addEventListener('click', () => {
        currentVehiclePage++;
        renderVehiclesList();
      });
      
      // Pagination motos
      document.getElementById('prev-bike-page').addEventListener('click', () => {
        if (currentBikePage > 1) {
          currentBikePage--;
          renderBikesList();
        }
      });
      
      document.getElementById('next-bike-page').addEventListener('click', () => {
        currentBikePage++;
        renderBikesList();
      });
      
      // Pagination groupes
      document.getElementById('prev-generator-page').addEventListener('click', () => {
        if (currentGeneratorPage > 1) {
          currentGeneratorPage--;
          renderGeneratorsList();
        }
      });
      
      document.getElementById('next-generator-page').addEventListener('click', () => {
        currentGeneratorPage++;
        renderGeneratorsList();
      });
      
      // Filtre historique
      document.getElementById('filter-type').addEventListener('change', renderHistory);
      
      // Formulaire véhicule
      document.getElementById('vehicule-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const vehicleData = {
          immatriculation: document.getElementById('immatriculation').value,
          marque: document.getElementById('marque').value,
          type: document.getElementById('type').value,
          date_circulation: document.getElementById('date_circulation').value,
          statut: document.getElementById('statut').value,
          localisation: document.getElementById('localisation').value,
          chauffeur: document.getElementById('chauffeur').value,
          observations: document.getElementById('observations').value,
          departement: document.getElementById('departement').value,
          destination: document.getElementById('destination').value,
          motif_deplacement: document.getElementById('motif_deplacement').value,
          km_avant: parseInt(document.getElementById('km_avant').value) || 0,
          km_apres: parseInt(document.getElementById('km_apres').value) || 0,
          km_parcouru: parseInt(document.getElementById('km_parcouru').value) || 0
        };
        
        if (editingVehicleId) {
          vehicleData.id = editingVehicleId;
          await updateVehicle(editingVehicleId, vehicleData);
        } else {
          await addVehicle(vehicleData);
        }
      });
      
      // Formulaire moto
      document.getElementById('bike-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const bikeData = {
          immatriculation: document.getElementById('bike_immatriculation').value,
          marque: document.getElementById('bike_marque').value,
          type: document.getElementById('bike_type').value,
          date_circulation: document.getElementById('bike_date_circulation').value,
          statut: document.getElementById('bike_statut').value,
          localisation: document.getElementById('bike_localisation').value,
          chauffeur: document.getElementById('bike_chauffeur').value,
          observations: document.getElementById('bike_observations').value
        };
        
        if (editingBikeId) {
          bikeData.id = editingBikeId;
          await updateBike(editingBikeId, bikeData);
        } else {
          await addBike(bikeData);
        }
      });
      
      // Formulaire groupe électrogène
      document.getElementById('generator-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const generatorData = {
          immatriculation: document.getElementById('generator_immatriculation').value,
          marque: document.getElementById('generator_marque').value,
          type: document.getElementById('generator_type').value,
          puissance: parseInt(document.getElementById('generator_puissance').value) || 0,
          date_mise_service: document.getElementById('generator_date_mise_service').value,
          statut: document.getElementById('generator_statut').value,
          localisation: document.getElementById('generator_localisation').value,
          observations: document.getElementById('generator_observations').value
        };
        
        if (editingGeneratorId) {
          generatorData.id = editingGeneratorId;
          await updateGenerator(editingGeneratorId, generatorData);
        } else {
          await addGenerator(generatorData);
        }
      });
      
      // Formulaire carburant véhicule
      document.getElementById('carburant-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const carburantData = {
          vehicle_id: document.getElementById('carburant_vehicule').value,
          date: document.getElementById('carburant_date').value,
          km_depart: parseInt(document.getElementById('carburant_km_depart').value) || 0,
          km_arrivee: parseInt(document.getElementById('carburant_km_arrivee').value) || 0,
          km_parcouru: parseInt(document.getElementById('carburant_km_parcouru').value) || 0,
          litres: parseFloat(document.getElementById('carburant_litres').value) || 0,
          consommation_100km: parseFloat(document.getElementById('carburant_consommation_100km').value) || 0,
          prix_unitaire: parseFloat(document.getElementById('carburant_prix_unitaire').value) || 0,
          type: document.getElementById('carburant_type').value,
          cout: parseFloat(document.getElementById('carburant_cout').value) || 0
        };
        
        await addVehicleFuel(carburantData);
        
        document.getElementById('carburant-form').reset();
        document.getElementById('carburant_km_parcouru').value = '';
        document.getElementById('carburant_cout').value = '';
      });
      
      // Formulaire carburant moto
      document.getElementById('bike-carburant-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const carburantData = {
          bike_id: document.getElementById('bike_carburant_moto').value,
          date: document.getElementById('bike_carburant_date').value,
          km_depart: parseInt(document.getElementById('bike_carburant_km_depart').value) || 0,
          km_arrivee: parseInt(document.getElementById('bike_carburant_km_arrivee').value) || 0,
          km_parcouru: parseInt(document.getElementById('bike_carburant_km_parcouru').value) || 0,
          litres: parseFloat(document.getElementById('bike_carburant_litres').value) || 0,
          consommation_100km: parseFloat(document.getElementById('bike_carburant_consommation_100km').value) || 0,
          prix_unitaire: parseFloat(document.getElementById('bike_carburant_prix_unitaire').value) || 0,
          type: document.getElementById('bike_carburant_type').value,
          cout: parseFloat(document.getElementById('bike_carburant_cout').value) || 0
        };
        
        await addBikeFuel(carburantData);
        
        document.getElementById('bike-carburant-form').reset();
        document.getElementById('bike_carburant_km_parcouru').value = '';
        document.getElementById('bike_carburant_cout').value = '';
      });
      
      // Formulaire carburant groupe
      document.getElementById('generator-carburant-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const carburantData = {
          generator_id: document.getElementById('generator_carburant_groupe').value,
          date: document.getElementById('generator_carburant_date').value,
          quantite_ravitailler: parseFloat(document.getElementById('generator_carburant_quantite_ravitailler').value) || 0,
          heure_marche: document.getElementById('generator_carburant_heure_marche').value,
          heure_arret: document.getElementById('generator_carburant_heure_arret').value,
          temps_fonctionnement: document.getElementById('generator_carburant_temps_fonctionnement').value,
          quantite_consommee_heure: parseFloat(document.getElementById('generator_carburant_quantite_consommee_heure').value) || 0,
          prix_unitaire: parseFloat(document.getElementById('generator_carburant_prix_unitaire').value) || 0,
          cout: parseFloat(document.getElementById('generator_carburant_cout').value) || 0
        };
        
        await addGeneratorFuel(carburantData);
        
        document.getElementById('generator-carburant-form').reset();
        document.getElementById('generator_carburant_temps_fonctionnement').value = '';
        document.getElementById('generator_carburant_cout').value = '';
      });
      
      // Formulaire maintenance véhicule
      document.getElementById('vehicle-maintenance-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const maintenanceData = {
          vehicle_id: document.getElementById('vehicle_maintenance_vehicule').value,
          date: document.getElementById('vehicle_maintenance_date').value,
          type: document.getElementById('vehicle_maintenance_type').value,
          cout: parseFloat(document.getElementById('vehicle_maintenance_cout').value) || 0,
          description: document.getElementById('vehicle_maintenance_description').value
        };
        
        await addVehicleMaintenance(maintenanceData);
        
        document.getElementById('vehicle-maintenance-form').reset();
      });
      
      // Formulaire maintenance moto
      document.getElementById('bike-maintenance-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const maintenanceData = {
          bike_id: document.getElementById('maintenance_bike').value,
          date: document.getElementById('maintenance_date').value,
          type: document.getElementById('maintenance_type').value,
          cout: parseFloat(document.getElementById('maintenance_cout').value) || 0,
          description: document.getElementById('maintenance_description').value
        };
        
        await addBikeMaintenance(maintenanceData);
        
        document.getElementById('bike-maintenance-form').reset();
      });
      
      // Formulaire maintenance groupe
      document.getElementById('generator-maintenance-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const maintenanceData = {
          generator_id: document.getElementById('generator_maintenance_groupe').value,
          date: document.getElementById('generator_maintenance_date').value,
          type: document.getElementById('generator_maintenance_type').value,
          cout: parseFloat(document.getElementById('generator_maintenance_cout').value) || 0,
          description: document.getElementById('generator_maintenance_description').value
        };
        
        await addGeneratorMaintenance(maintenanceData);
        
        document.getElementById('generator-maintenance-form').reset();
      });
      
      // Fermeture des modales
      document.querySelectorAll('.close-modal').forEach(button => {
        button.addEventListener('click', function() {
          this.closest('.modal').classList.remove('show');
        });
      });
      
      // Fermeture des modales en cliquant à l'extérieur
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            this.classList.remove('show');
          }
        });
      });
      
      // Export Excel
      document.getElementById('export-excel').addEventListener('click', async () => {
        const vehicles = await getVehicles();
        const bikes = await getBikes();
        const generators = await getGenerators();
        
        const wb = XLSX.utils.book_new();
        
        // Feuille Véhicules
        const vehicleData = vehicles.map(v => ({
          'Immatriculation': v.immatriculation,
          'Marque/Modèle': v.marque,
          'Type': v.type,
          'Date circulation': v.date_circulation,
          'Statut': v.statut,
          'Localisation': v.localisation,
          'Chauffeur': v.chauffeur,
          'Département': v.departement,
          'Destination': v.destination,
          'Motif déplacement': v.motif_deplacement,
          'Km avant': v.km_avant,
          'Km après': v.km_apres,
          'Km parcouru': v.km_parcouru,
          'Observations': v.observations
        }));
        const ws1 = XLSX.utils.json_to_sheet(vehicleData);
        XLSX.utils.book_append_sheet(wb, ws1, 'Véhicules');
        
        // Feuille Motos
        const bikeData = bikes.map(b => ({
          'Immatriculation': b.immatriculation,
          'Marque/Modèle': b.marque,
          'Type': b.type,
          'Date circulation': b.date_circulation,
          'Statut': b.statut,
          'Localisation': b.localisation,
          'Chauffeur': b.chauffeur,
          'Observations': b.observations
        }));
        const ws2 = XLSX.utils.json_to_sheet(bikeData);
        XLSX.utils.book_append_sheet(wb, ws2, 'Motos');
        
        // Feuille Groupes
        const generatorData = generators.map(g => ({
          'N° Inventaire': g.immatriculation,
          'Marque/Modèle': g.marque,
          'Puissance (kVA)': g.puissance,
          'Type': g.type,
          'Date mise service': g.date_mise_service,
          'Statut': g.statut,
          'Localisation': g.localisation,
          'Observations': g.observations
        }));
        const ws3 = XLSX.utils.json_to_sheet(generatorData);
        XLSX.utils.book_append_sheet(wb, ws3, 'Groupes Électrogènes');
        
        XLSX.writeFile(wb, `gestion_flotte_${new Date().toISOString().split('T')[0]}.xlsx`);
        showToast('Export Excel généré avec succès', 'success');
      });
      
      // Initialiser les calculs automatiques
      setupAutoCalculations();
      
      // Rendre les listes initiales
      renderVehiclesList();
      renderBikesList();
      renderGeneratorsList();
      renderHistory();
      
      // Test de connexion Supabase
      testSupabaseConnection();
      
      console.log("Application initialisée avec succès");
    }

    async function testSupabaseConnection() {
      if (!supabase) {
        console.log("Supabase non initialisé, mode local uniquement");
        showToast('Mode local activé (Supabase non disponible)', 'warning');
        return;
      }
      
      try {
        const { data, error } = await supabase
          .from('vehicles')
          .select('count')
          .limit(1);
        
        if (error) {
          console.log('Supabase: Erreur de connexion', error);
          showToast('Mode local activé (Supabase erreur)', 'warning');
        } else {
          console.log('Supabase: Connexion réussie');
          showToast('Connecté à Supabase', 'success');
        }
      } catch (error) {
        console.log('Supabase: Erreur de connexion', error);
        showToast('Mode local activé', 'warning');
      }
    }

    // Démarrer l'application quand le DOM est chargé
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
  </script>
</body>
</html>
