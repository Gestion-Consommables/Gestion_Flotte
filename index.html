<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestion des Flottes - Poste Guinéenne</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Add Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2ecc71;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --dark-color: #2c3e50;
      --light-color: #ecf0f1;
      --text-color: #333;
      --text-light: #7f8c8d;
      --border-color: #ddd;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    [data-theme="dark"] {
      --primary-color: #2980b9;
      --secondary-color: #27ae60;
      --dark-color: #ecf0f1;
      --light-color: #2c3e50;
      --text-color: #ecf0f1;
      --text-light: #bdc3c7;
      --border-color: #34495e;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: var(--text-color);
      background-color: #f5f7fa;
      transition: var(--transition);
    }

    [data-theme="dark"] body {
      background-color: #1a1a1a;
    }

    .container {
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }
    .app-header {
      background-color: var(--dark-color);
      color: white;
      padding: 1rem 0;
      box-shadow: var(--shadow);
      margin-bottom: 2rem;
    }

    .app-header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  
    .header-logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .header-logo {
      height: 50px;
      display: flex;
      align-items: center;
      background-color: #1a3a6d;
      padding: 0 15px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .logo-text {
      text-align: center;
      line-height: 1.2;
      font-weight: bold;
      color: white;
    }
    
    .logo-main {
      font-size: 18px;
      text-transform: uppercase;
    }
    
    .logo-sub {
      font-size: 14px;
    }
    
    .logo-slogan {
      font-size: 10px;
      color: #f9c642;
      margin-top: 2px;
    }

    .app-header h1 {
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0;
    }

    .header-actions {
      display: flex;
      gap: 15px;
    }

  
    .nav-tabs {
      display: flex;
      gap: 5px;
      margin-right: 15px;
    }

    .nav-tab {
      padding: 8px 15px;
      background: none;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      color: white;
    }

    .nav-tab.active {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .nav-tab:not(.active):hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    
    .grid-layout {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 2rem;
    }

    
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: var(--shadow);
      overflow: hidden;
      transition: var(--transition);
    }

    [data-theme="dark"] .card {
      background-color: #252525;
    }

    .card-header {
      padding: 1rem;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-header h2 {
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-body {
      padding: 1rem;
    }

    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--text-color);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1rem;
      transition: var(--transition);
      background-color: var(--light-color);
      color: var(--text-color);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }

    .full-width {
      grid-column: 1 / -1;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .search-box {
      position: relative;
      width: 200px;
    }

    .search-box input {
      width: 100%;
      padding: 8px 30px 8px 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }

    .search-box i {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
    }

    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background-color: #2980b9;
    }

    .btn-secondary {
      background-color: var(--secondary-color);
      color: white;
    }

    .btn-secondary:hover {
      background-color: #27ae60;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--text-color);
    }

    .btn-outline:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.8rem;
    }

    
    .table-responsive {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border-color);
    }

    th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 500;
    }

    tr:hover {
      background-color: rgba(0, 0, 0, 0.02);
    }

    [data-theme="dark"] tr:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .table-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      font-size: 0.9rem;
    }

    .pagination {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pagination button {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--primary-color);
      font-size: 1rem;
    }

    .pagination button:disabled {
      color: var(--text-light);
      cursor: not-allowed;
    }

    
    .timeline {
      position: relative;
      padding-left: 30px;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 10px;
      top: 0;
      bottom: 0;
      width: 2px;
      background-color: var(--primary-color);
    }

    .timeline-item {
      position: relative;
      padding-bottom: 20px;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: -30px;
      top: 5px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: var(--primary-color);
    }

    .timeline-date {
      font-size: 0.8rem;
      color: var(--text-light);
      margin-bottom: 5px;
    }

    .timeline-content {
      background-color: var(--light-color);
      padding: 10px 15px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background-color: white;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    [data-theme="dark"] .modal-content {
      background-color: #252525;
    }

    .modal-header {
      padding: 15px 20px;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 15px 20px;
      display: flex;
      justify-content: flex-end;
      border-top: 1px solid var(--border-color);
    }

    .close-modal {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: white;
    }

    
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--dark-color);
      color: white;
      padding: 15px 20px;
      border-radius: 4px;
      box-shadow: var(--shadow);
      transform: translateY(100px);
      opacity: 0;
      transition: var(--transition);
      z-index: 1100;
    }

    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    
    .bike-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .bike-status.en-service {
      background-color: #d4edda;
      color: #155724;
    }

    .bike-status.en-panne {
      background-color: #f8d7da;
      color: #721c24;
    }

    .bike-status.en-maintenance {
      background-color: #fff3cd;
      color: #856404;
    }

    [data-theme="dark"] .bike-status.en-service {
      background-color: #155724;
      color: #d4edda;
    }

    [data-theme="dark"] .bike-status.en-panne {
      background-color: #721c24;
      color: #f8d7da;
    }

    [data-theme="dark"] .bike-status.en-maintenance {
      background-color: #856404;
      color: #fff3cd;
    }

    
    .detail-item {
      margin-bottom: 15px;
    }

    .detail-label {
      font-weight: 600;
      display: block;
      margin-bottom: 5px;
      color: var(--primary-color);
    }

    .detail-value {
      display: block;
    }

    .full-width {
      width: 100%;
    }

    .maintenance-title {
      margin: 20px 0 10px;
      padding-bottom: 5px;
      border-bottom: 1px solid var(--border-color);
    }

    .maintenance-item {
      padding: 10px;
      margin-bottom: 10px;
      background-color: var(--light-color);
      border-radius: 4px;
    }

    .maintenance-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .maintenance-type {
      font-weight: 600;
    }

    .maintenance-date {
      color: var(--text-light);
      font-size: 0.9rem;
    }

    .maintenance-cost {
      font-weight: 500;
      margin-bottom: 5px;
    }

    .maintenance-description {
      font-size: 0.9rem;
    }

    
    .localisation-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .localisation-status.garage {
      background-color: #e3f2fd;
      color: #1565c0;
    }

    .localisation-status.en-circulation {
      background-color: #e8f5e8;
      color: #2e7d32;
    }

    .localisation-status.bureau {
      background-color: #fff3e0;
      color: #ef6c00;
    }

    .localisation-status.fixe {
      background-color: #e3f2fd;
      color: #1565c0;
    }

    .localisation-status.mobile {
      background-color: #e8f5e8;
      color: #2e7d32;
    }

    .localisation-status.autre-site {
      background-color: #fff3e0;
      color: #ef6c00;
    }

    [data-theme="dark"] .localisation-status.garage {
      background-color: #0d47a1;
      color: #e3f2fd;
    }

    [data-theme="dark"] .localisation-status.en-circulation {
      background-color: #1b5e20;
      color: #e8f5e8;
    }

    [data-theme="dark"] .localisation-status.bureau {
      background-color: #e65100;
      color: #fff3e0;
    }

    [data-theme="dark"] .localisation-status.fixe {
      background-color: #0d47a1;
      color: #e3f2fd;
    }

    [data-theme="dark"] .localisation-status.mobile {
      background-color: #1b5e20;
      color: #e8f5e8;
    }

    [data-theme="dark"] .localisation-status.autre-site {
      background-color: #e65100;
      color: #fff3e0;
    }

  
    .mb-3 { margin-bottom: 1rem; }
    .mt-3 { margin-top: 1rem; }
    .text-center { text-align: center; }
    .d-flex { display: flex; }
    .align-center { align-items: center; }
    .justify-between { justify-content: space-between; }

  
    @media (max-width: 768px) {
      .app-header .container {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .header-logo-container {
        flex-direction: column;
        text-align: center;
      }
      
      .header-logo {
        margin-bottom: 10px;
      }
      
      .header-actions {
        width: 100%;
        justify-content: center;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .table-footer {
        flex-direction: column;
        gap: 15px;
      }
      
      .modal-content {
        width: 95%;
      }
    }

    @media (max-width: 480px) {
      .card-header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
      }
      
      .form-actions {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
      
      .nav-tabs {
        margin-right: 0;
        margin-bottom: 10px;
      }
      
      .header-logo {
        height: 40px;
        padding: 0 10px;
      }
      
      .logo-main {
        font-size: 16px;
      }
      
      .logo-sub {
        font-size: 12px;
      }
      
      .logo-slogan {
        font-size: 9px;
      }
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="container">
      <div class="header-logo-container">
        <div class="header-logo">
          
          <div class="logo-text">
            <div class="logo-main">LA POSTE</div>
            <div class="logo-sub">GUINÉENNE</div>
            <div class="logo-slogan">Confiance - Innovation - Proximité</div>
          </div>
        </div>
        <h1><i class="fas fa-truck-moving"></i> Gestion des Flottes</h1>
      </div>
      <div class="header-actions">
        <div class="nav-tabs">
          <button class="nav-tab active" data-tab="vehicles"><i class="fas fa-car"></i> Véhicules</button>
          <button class="nav-tab" data-tab="bikes"><i class="fas fa-bicycle"></i> Motos</button>
          <button class="nav-tab" data-tab="generators"><i class="fas fa-bolt"></i> Groupes Électrogènes</button>
        </div>
        <button id="export-excel" class="btn btn-primary"><i class="fas fa-file-excel"></i> Exporter Excel</button>
        <button id="toggle-theme" class="btn btn-secondary"><i class="fas fa-moon"></i></button>
      </div>
    </div>
  </header>

  <main class="container">
    
    <div id="vehicles-tab" class="tab-content active">
      <div class="grid-layout">
        
        <section id="form-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-car"></i> Ajouter/Modifier un Véhicule</h2>
            <button id="clear-form" class="btn btn-sm btn-outline">Nouveau</button>
          </div>
          <div class="card-body">
            <form id="vehicule-form" class="form-grid">
              <div class="form-group">
                <label for="immatriculation">Immatriculation</label>
                <input type="text" id="immatriculation" placeholder="Ex: ABC1234" required />
              </div>
              
              <div class="form-group">
                <label for="marque">Marque/Modèle</label>
                <input type="text" id="marque" placeholder="Ex: Toyota Hilux" required />
              </div>
              
              <div class="form-group">
                <label for="type">Type</label>
                <select id="type" required>
                  <option value="">Sélectionner...</option>
                  <option value="voiture">Voiture</option>
                  <option value="camion">Camion</option>
                  <option value="bus">Bus</option>
                  <option value="pick-up">Pick-up</option>
                  <option value="van">Van</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              
              
              <div class="form-group">
                <label for="date_circulation">Date de mise en circulation</label>
                <input type="text" id="date_circulation" placeholder="JJ MM AAAA" required />
                <small style="color: var(--text-light); font-size: 0.8rem;">Format: Jour Mois Année (ex: 15 03 2020)</small>
              </div>
              
              <div class="form-group">
                <label for="statut">Statut</label>
                <select id="statut" required>
                  <option value="en service">En service</option>
                  <option value="en panne">En panne</option>
                  <option value="en maintenance">En maintenance</option>
                  <option value="hors service">Hors service</option>
                </select>
              </div>

              
              <div class="form-group">
                <label for="localisation">Localisation</label>
                <select id="localisation" required>
                  <option value="garage">Garage</option>
                  <option value="en-circulation">En circulation</option>
                  <option value="bureau">Bureau</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="chauffeur">Facteur assigné</label>
                <input type="text" id="chauffeur" placeholder="Nom et prénom du facteur" />
              </div>
              
              <div class="form-group full-width">
                <label for="observations">Observations</label>
                <textarea id="observations" placeholder="Notes sur l'état du véhicule"></textarea>
              </div>
              
              
              <div class="form-group">
                <label for="departement">Département Utilisateur</label>
                <select id="departement" required>
                  <option value="">Sélectionner...</option>
                  <option value="DG">Direction Générale (DG)</option>
                  <option value="DGA">Direction Générale Adjointe (DGA)</option>
                  <option value="DSI">Direction des Systèmes d'Information (DSI)</option>
                  <option value="DSP">Direction des Services Postaux (DSP)</option>
                  <option value="DRH">Direction des Ressources Humaines (DRH)</option>
                  <option value="DPLMG">Direction de la Logistique et Moyens Généraux (DPLMG)</option>
                  <option value="DSPS">Direction de la Sécurité et Protection Sociale (DSPS)</option>
                  <option value="DACQ">Direction des Achats (DACQ)</option>
                  <option value="DSJ">Direction des Services Juridiques (DSJ)</option>
                  <option value="DAF">Direction des Affaires Financières (DAF)</option>
                </select>
              </div>

              <div class="form-group">
                <label for="destination">Destination</label>
                <input type="text" id="destination" placeholder="Lieu de destination" />
              </div>

              <div class="form-group">
                <label for="motif_deplacement">Motif du Déplacement</label>
                <input type="text" id="motif_deplacement" placeholder="Raison du déplacement" />
              </div>

              <div class="form-group">
                <label for="km_avant">Kilométrage Départ</label>
                <input type="number" id="km_avant" placeholder="Kilométrage au départ" />
              </div>

              <div class="form-group">
                <label for="km_apres">Kilométrage Arrivée</label>
                <input type="number" id="km_apres" placeholder="Kilométrage à l'arrivée" />
              </div>

              <div class="form-group">
                <label for="km_parcouru">kilometrage parcouru</label>
                <input type="number" id="km_parcouru" placeholder="Calcul automatique" readonly />
              </div>
              
              <div class="form-actions full-width">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Enregistrer</button>
                <button type="button" id="cancel-edit" class="btn btn-outline">Annuler</button>
              </div>
            </form>
          </div>
        </section>

        
        <section id="carburant-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-gas-pump"></i> Ravitaillement en carburant</h2>
          </div>
          <div class="card-body">
            <form id="carburant-form" class="form-grid">
              <div class="form-group">
                <label for="carburant_vehicule">Véhicule</label>
                <select id="carburant_vehicule" required>
                  <option value="">Sélectionner un véhicule...</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="carburant_date">Date</label>
                <input type="text" id="carburant_date" placeholder="JJ MM AAAA" required />
                <small style="color: var(--text-light); font-size: 0.8rem;">Format: Jour Mois Année</small>
              </div>
              
              <div class="form-group">
                <label for="carburant_km_depart">Kilométrage Départ</label>
                <input type="number" id="carburant_km_depart" placeholder="Km au départ" required />
              </div>
              
              <div class="form-group">
                <label for="carburant_km_arrivee">Kilométrage Arrivée Station</label>
                <input type="number" id="carburant_km_arrivee" placeholder="Km à l'arrivée station" required />
              </div>
              
              <div class="form-group">
                <label for="carburant_km_parcouru">Kilométrage Parcouru (calculé)</label>
                <input type="number" id="carburant_km_parcouru" placeholder="Calcul automatique" readonly />
              </div>
              
              <div class="form-group">
                <label for="carburant_litres">Quantité Ravitaillée (L)</label>
                <input type="number" step="0.1" id="carburant_litres" placeholder="Ex: 45.5" required />
              </div>
              
              
              <div class="form-group">
                <label for="carburant_consommation_100km">Consommation sur 100 Km</label>
                <input type="number" step="0.1" id="carburant_consommation_100km" placeholder="Saisir la consommation" />
              </div>
              
              <div class="form-group">
                <label for="carburant_prix_unitaire">Prix Unitaire (GNF)</label>
                <input type="number" step="0.01" id="carburant_prix_unitaire" placeholder="Ex: 1250" required />
              </div>
              
              <div class="form-group">
                <label for="carburant_type">Type de carburant</label>
                <select id="carburant_type" required>
                  <option value="gasoil">Gasoil</option>
                  <option value="essence">Essence</option>
                  <option value="gnc">GNC</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="carburant_cout">Coût Total (calculé)</label>
                <input type="number" step="0.01" id="carburant_cout" placeholder="Calcul automatique" readonly />
              </div>
              
              <div class="form-group full-width">
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Ajouter Ravitaillement</button>
              </div>
            </form>
          </div>
        </section>

        
        <section id="vehicle-maintenance-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-tools"></i> Maintenance des Véhicules</h2>
          </div>
          <div class="card-body">
            <form id="vehicle-maintenance-form" class="form-grid">
              <div class="form-group">
                <label for="vehicle_maintenance_vehicule">Véhicule</label>
                <select id="vehicle_maintenance_vehicule" required>
                  <option value="">Sélectionner un véhicule...</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="vehicle_maintenance_date">Date</label>
                <input type="text" id="vehicle_maintenance_date" placeholder="JJ MM AAAA" required />
                <small style="color: var(--text-light); font-size: 0.8rem;">Format: Jour Mois Année</small>
              </div>
              
              <div class="form-group">
                <label for="vehicle_maintenance_type">Type de maintenance</label>
                <select id="vehicle_maintenance_type" required>
                  <option value="entretien_kilometrique">Entretien kilométrique</option>
                  <option value="freins">Freins</option>
                  <option value="pneus">Pneus</option>
                  <option value="climatisation">Climatisation</option>
                  <option value="electrique">Problème électrique</option>
                  <option value="moteur">Problème de moteur</option>
                  <option value="carrosserie">Problème de carrosserie</option>
                  <option value="suspension">Problème de suspension</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="vehicle_maintenance_cout">Coût (GNF)</label>
                <input type="number" step="0.01" id="vehicle_maintenance_cout" placeholder="Ex: 325000" required />
              </div>
              
              <div class="form-group full-width">
                <label for="vehicle_maintenance_description">Description</label>
                <textarea id="vehicle_maintenance_description" placeholder="Détails de la maintenance, pièces remplacées..."></textarea>
              </div>
              
              <div class="form-group full-width">
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Ajouter Maintenance</button>
              </div>
            </form>
          </div>
        </section>

      
        <section id="vehicules-list" class="card">
          <div class="card-header">
            <h2><i class="fas fa-list"></i> Liste des Véhicules</h2>
            <div class="search-box">
              <input type="text" id="search-vehicule" placeholder="Rechercher véhicule...">
              <i class="fas fa-search"></i>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table id="vehicules-table">
                <thead>
                  <tr>
                    <th>Immat.</th>
                    <th>Marque/Modèle</th>
                    <th>Type</th>
                    <th>Statut</th>
                    <th>Localisation</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="liste-vehicules">
                  
                </tbody>
              </table>
            </div>
            <div class="table-footer">
              <div class="table-info" id="vehicule-count">0 véhicules</div>
              <div class="pagination">
                <button id="prev-page" disabled><i class="fas fa-chevron-left"></i></button>
                <span id="page-info">Page 1</span>
                <button id="next-page" disabled><i class="fas fa-chevron-right"></i></button>
              </div>
            </div>
          </div>
        </section>

        
        <section id="historique-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-history"></i> Historique des Actions</h2>
            <div class="filter-actions">
              <select id="filter-type">
                <option value="all">Tous les types</option>
                <option value="vehicle">Véhicules</option>
                <option value="fuel">Carburant</option>
                <option value="maintenance">Maintenance</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div class="timeline" id="historique">
              
            </div>
          </div>
        </section>
      </div>
    </div>

    
    <div id="bikes-tab" class="tab-content">
      <div class="grid-layout">
        
        <section id="bike-form-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-bicycle"></i> Ajouter/Modifier une Moto</h2>
            <button id="clear-bike-form" class="btn btn-sm btn-outline">Nouveau</button>
          </div>
          <div class="card-body">
            <form id="bike-form" class="form-grid">
              <div class="form-group">
                <label for="bike_immatriculation">Immatriculation</label>
                <input type="text" id="bike_immatriculation" placeholder="Ex: MOTO1234" required />
              </div>
              
              <div class="form-group">
                <label for="bike_marque">Marque/Modèle</label>
                <input type="text" id="bike_marque" placeholder="Ex: Yamaha XTZ" required />
              </div>
              
              <div class="form-group">
                <label for="bike_type">Type</label>
                <select id="bike_type" required>
                  <option value="">Sélectionner...</option>
                  <option value="moto_cross">Moto Cross</option>
                  <option value="moto_routiere">Moto Routière</option>
                  <option value="scooter">Scooter</option>
                  <option value="tricycle">Tricycle</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              
              
              <div class="form-group">
                <label for="bike_date_circulation">Date de mise en circulation</label>
                <input type="text" id="bike_date_circulation" placeholder="JJ MM AAAA" required />
                <small style="color: var(--text-light); font-size: 0.8rem;">Format: Jour Mois Année (ex: 15 03 2020)</small>
              </div>
              
              <div class="form-group">
                <label for="bike_statut">Statut</label>
                <select id="bike_statut" required>
                  <option value="en service">En service</option>
                  <option value="en panne">En panne</option>
                  <option value="en maintenance">En maintenance</option>
                  <option value="hors service">Hors service</option>
                </select>
              </div>

              
              <div class="form-group">
                <label for="bike_localisation">Localisation</label>
                <select id="bike_localisation" required>
                  <option value="garage">Garage</option>
                  <option value="en-circulation">En circulation</option>
                  <option value="bureau">Bureau</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="bike_chauffeur">Facteur assigné</label>
                <input type="text" id="bike_chauffeur" placeholder="Nom et prénom du facteur" />
              </div>
              
              <div class="form-group full-width">
                <label for="bike_observations">Observations</label>
                <textarea id="bike_observations" placeholder="Notes sur l'état de la moto"></textarea>
              </div>
              
              <div class="form-actions full-width">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Enregistrer</button>
                <button type="button" id="cancel-bike-edit" class="btn btn-outline">Annuler</button>
              </div>
            </form>
          </div>
        </section>

      
        <section id="bike-carburant-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-gas-pump"></i> Ravitaillement en carburant (Motos)</h2>
          </div>
          <div class="card-body">
            <form id="bike-carburant-form" class="form-grid">
              <div class="form-group">
                <label for="bike_carburant_moto">Moto</label>
                <select id="bike_carburant_moto" required>
                  <option value="">Sélectionner une moto...</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="bike_carburant_date">Date</label>
                <input type="text" id="bike_carburant_date" placeholder="JJ MM AAAA" required />
                <small style="color: var(--text-light); font-size: 0.8rem;">Format: Jour Mois Année</small>
              </div>
              
              <div class="form-group">
                <label for="bike_carburant_km_depart">Kilométrage Départ</label>
                <input type="number" id="bike_carburant_km_depart" placeholder="Km au départ" required />
              </div>
              
              <div class="form-group">
                <label for="bike_carburant_km_arrivee">Kilométrage Arrivée Station</label>
                <input type="number" id="bike_carburant_km_arrivee" placeholder="Km à l'arrivée station" required />
              </div>
              
              <div class="form-group">
                <label for="bike_carburant_km_parcouru">Kilométrage Parcouru (calculé)</label>
                <input type="number" id="bike_carburant_km_parcouru" placeholder="Calcul automatique" readonly />
              </div>
              
              <div class="form-group">
                <label for="bike_carburant_litres">Quantité Ravitaillée (L)</label>
                <input type="number" step="0.1" id="bike_carburant_litres" placeholder="Ex: 10.5" required />
              </div>
              
          
              <div class="form-group">
                <label for="bike_carburant_consommation_100km">Consommation sur 100 Km</label>
                <input type="number" step="0.1" id="bike_carburant_consommation_100km" placeholder="Saisir la consommation" />
              </div>
              
              <div class="form-group">
                <label for="bike_carburant_prix_unitaire">Prix Unitaire (GNF)</label>
                <input type="number" step="0.01" id="bike_carburant_prix_unitaire" placeholder="Ex: 1250" required />
              </div>
              
              <div class="form-group">
                <label for="bike_carburant_type">Type de carburant</label>
                <select id="bike_carburant_type" required>
                  <option value="essence">Essence</option>
                  <option value="gasoil">Gasoil</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="bike_carburant_cout">Coût Total (calculé)</label>
                <input type="number" step="0.01" id="bike_carburant_cout" placeholder="Calcul automatique" readonly />
              </div>
              
              <div class="form-group full-width">
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Ajouter Ravitaillement</button>
              </div>
            </form>
          </div>
        </section>

        
        <section id="bike-maintenance-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-tools"></i> Maintenance des Motos</h2>
          </div>
          <div class="card-body">
            <form id="bike-maintenance-form" class="form-grid">
              <div class="form-group">
                <label for="maintenance_bike">Moto</label>
                <select id="maintenance_bike" required>
                  <option value="">Sélectionner une moto...</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="maintenance_date">Date</label>
                <input type="text" id="maintenance_date" placeholder="JJ MM AAAA" required />
                <small style="color: var(--text-light); font-size: 0.8rem;">Format: Jour Mois Année</small>
              </div>
              
              <div class="form-group">
                <label for="maintenance_type">Type de maintenance</label>
                <select id="maintenance_type" required>
                  <option value="entretien_kilometrique">Entretien kilométrique</option>
                  <option value="freins">Freins</option>
                  <option value="pneus">Pneus</option>
                  <option value="electrique">Problème électrique</option>
                  <option value="moteur">Problème de moteur</option>
                  <option value="carrosserie">Problème de carrosserie</option>
                  <option value="suspension">Problème de suspension</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="maintenance_cout">Coût (GNF)</label>
                <input type="number" step="0.01" id="maintenance_cout" placeholder="Ex: 125000" required />
              </div>
              
              <div class="form-group full-width">
                <label for="maintenance_description">Description</label>
                <textarea id="maintenance_description" placeholder="Détails de la maintenance"></textarea>
              </div>
              
              <div class="form-group full-width">
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Ajouter Maintenance</button>
              </div>
            </form>
          </div>
        </section>

      
        <section id="bikes-list" class="card">
          <div class="card-header">
            <h2><i class="fas fa-list"></i> Liste des Motos</h2>
            <div class="search-box">
              <input type="text" id="search-bike" placeholder="Rechercher moto...">
              <i class="fas fa-search"></i>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table id="bikes-table">
                <thead>
                  <tr>
                    <th>Immat.</th>
                    <th>Marque/Modèle</th>
                    <th>Type</th>
                    <th>Statut</th>
                    <th>Localisation</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="liste-bikes">
                
                </tbody>
              </table>
            </div>
            <div class="table-footer">
              <div class="table-info" id="bike-count">0 motos</div>
              <div class="pagination">
                <button id="prev-bike-page" disabled><i class="fas fa-chevron-left"></i></button>
                <span id="bike-page-info">Page 1</span>
                <button id="next-bike-page" disabled><i class="fas fa-chevron-right"></i></button>
              </div>
            </div>
          </div>
        </section>

    
        <section id="bike-history-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-history"></i> Historique des Motos</h2>
            <div class="filter-actions">
              <select id="bike-filter-type">
                <option value="all">Tous les types</option>
                <option value="bike">Motos</option>
                <option value="maintenance">Maintenance</option>
                <option value="fuel">Carburant</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div class="timeline" id="bike-history">
            
            </div>
          </div>
        </section>
      </div>
    </div>


    <div id="generators-tab" class="tab-content">
      <div class="grid-layout">
        
        <section id="generator-form-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-bolt"></i> Ajouter/Modifier un Groupe Électrogène</h2>
            <button id="clear-generator-form" class="btn btn-sm btn-outline">Nouveau</button>
          </div>
          <div class="card-body">
            <form id="generator-form" class="form-grid">
              <div class="form-group">
                <label for="generator_immatriculation">Numéro d'inventaire</label>
                <input type="text" id="generator_immatriculation" placeholder="Ex: GEN001" required />
              </div>
              
              <div class="form-group">
                <label for="generator_marque">Marque/Modèle</label>
                <input type="text" id="generator_marque" placeholder="Ex: Caterpillar 500kVA" required />
              </div>
              
              <div class="form-group">
                <label for="generator_type">Type</label>
                <select id="generator_type" required>
                  <option value="">Sélectionner...</option>
                  <option value="diesel">Diesel</option>
                  <option value="essence">Essence</option>
                  <option value="gaz">Gaz</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="generator_puissance">Puissance (kVA)</label>
                <input type="number" id="generator_puissance" placeholder="Ex: 500" required />
              </div>
              
              <div class="form-group">
                <label for="generator_date_mise_service">Date de mise en service</label>
                <input type="text" id="generator_date_mise_service" placeholder="JJ MM AAAA" required />
                <small style="color: var(--text-light); font-size: 0.8rem;">Format: Jour Mois Année</small>
              </div>
              
              <div class="form-group">
                <label for="generator_statut">Statut</label>
                <select id="generator_statut" required>
                  <option value="en service">En service</option>
                  <option value="en panne">En panne</option>
                  <option value="en maintenance">En maintenance</option>
                  <option value="hors service">Hors service</option>
                </select>
              </div>

              
              <div class="form-group">
                <label for="generator_localisation">Localisation</label>
                <select id="generator_localisation" required>
                  <option value="fixe">Fixe</option>
                  <option value="mobile">Mobile</option>
                  <option value="autre-site">Affecté à un autre site temporaire</option>
                </select>
              </div>
              
              <div class="form-group full-width">
                <label for="generator_observations">Observations</label>
                <textarea id="generator_observations" placeholder="Notes sur l'état du groupe électrogène"></textarea>
              </div>
              
              <div class="form-actions full-width">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Enregistrer</button>
                <button type="button" id="cancel-generator-edit" class="btn btn-outline">Annuler</button>
              </div>
            </form>
          </div>
        </section>

  
        <section id="generator-carburant-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-gas-pump"></i> Ravitaillement Groupes Électrogènes</h2>
          </div>
          <div class="card-body">
            <form id="generator-carburant-form" class="form-grid">
              <div class="form-group">
                <label for="generator_carburant_groupe">Groupe Électrogène</label>
                <select id="generator_carburant_groupe" required>
                  <option value="">Sélectionner un groupe...</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="generator_carburant_date">Date</label>
                <input type="text" id="generator_carburant_date" placeholder="JJ MM AAAA" required />
                <small style="color: var(--text-light); font-size: 0.8rem;">Format: Jour Mois Année</small>
              </div>
              
              <div class="form-group">
                <label for="generator_carburant_quantite_ravitailler">Quantité ravitaillée (L)</label>
                <input type="number" step="0.1" id="generator_carburant_quantite_ravitailler" placeholder="Ex: 45.5" required />
              </div>
              
              <div class="form-group">
                <label for="generator_carburant_heure_marche">Heure de marche</label>
                <input type="time" id="generator_carburant_heure_marche" required />
              </div>
              
              <div class="form-group">
                <label for="generator_carburant_heure_arret">Heure d'arrêt</label>
                <input type="time" id="generator_carburant_heure_arret" required />
              </div>
              
              <!-- Champ temps de fonctionnement maintenant automatique et en lecture seule -->
              <div class="form-group">
                <label for="generator_carburant_temps_fonctionnement">Temps de fonctionnement</label>
                <input type="text" id="generator_carburant_temps_fonctionnement" placeholder="Calcul automatique" readonly />
                <small style="color: var(--text-light); font-size: 0.8rem;">Calculé automatiquement</small>
              </div>
              
              <div class="form-group">
                <label for="generator_carburant_quantite_consommee_heure">Quantité consommée par heure (L/h)</label>
                <input type="number" step="0.1" id="generator_carburant_quantite_consommee_heure" placeholder="Ex: 12.5" required />
              </div>
              
              <div class="form-group">
                <label for="generator_carburant_prix_unitaire">Prix Unitaire (GNF)</label>
                <input type="number" step="0.01" id="generator_carburant_prix_unitaire" placeholder="Ex: 1250" required />
              </div>
              
              <div class="form-group">
                <label for="generator_carburant_cout">Coût Total (calculé)</label>
                <input type="number" step="0.01" id="generator_carburant_cout" placeholder="Calcul automatique" readonly />
              </div>
              
              <div class="form-group full-width">
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Ajouter Ravitaillement</button>
              </div>
            </form>
          </div>
        </section>


        <section id="generator-maintenance-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-tools"></i> Maintenance des Groupes Électrogènes</h2>
          </div>
          <div class="card-body">
            <form id="generator-maintenance-form" class="form-grid">
              <div class="form-group">
                <label for="generator_maintenance_groupe">Groupe Électrogène</label>
                <select id="generator_maintenance_groupe" required>
                  <option value="">Sélectionner un groupe...</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="generator_maintenance_date">Date</label>
                <input type="text" id="generator_maintenance_date" placeholder="JJ MM AAAA" required />
                <small style="color: var(--text-light); font-size: 0.8rem;">Format: Jour Mois Année</small>
              </div>
              
              <div class="form-group">
                <label for="generator_maintenance_type">Type de maintenance</label>
                <select id="generator_maintenance_type" required>
                  <option value="entretien_preventif">Entretien préventif</option>
                  <option value="entretien_correctif">Entretien correctif</option>
                  <option value="changement_filtres">Changement des filtres</option>
                  <option value="vidange_huile">Vidange d'huile</option>
                  <option value="nettoyage_injecteurs">Nettoyage injecteurs</option>
                  <option value="revision_moteur">Révision moteur</option>
                  <option value="controle_electrique">Contrôle électrique</option>
                  <option value="changement_batterie">Changement batterie</option>
                  <option value="autre">Autre</option>
                </select>
              </div>
              
              <div class="form-group">
                <label for="generator_maintenance_cout">Coût (GNF)</label>
                <input type="number" step="0.01" id="generator_maintenance_cout" placeholder="Ex: 450000" required />
              </div>
              
              <div class="form-group full-width">
                <label for="generator_maintenance_description">Description</label>
                <textarea id="generator_maintenance_description" placeholder="Détails de la maintenance, pièces remplacées..."></textarea>
              </div>
              
              <div class="form-group full-width">
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Ajouter Maintenance</button>
              </div>
            </form>
          </div>
        </section>

      
        <section id="generators-list" class="card">
          <div class="card-header">
            <h2><i class="fas fa-list"></i> Liste des Groupes Électrogènes</h2>
            <div class="search-box">
              <input type="text" id="search-generator" placeholder="Rechercher groupe...">
              <i class="fas fa-search"></i>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table id="generators-table">
                <thead>
                  <tr>
                    <th>N° Inventaire</th>
                    <th>Marque/Modèle</th>
                    <th>Puissance</th>
                    <th>Type</th>
                    <th>Statut</th>
                    <th>Localisation</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="liste-generators">
                
                </tbody>
              </table>
            </div>
            <div class="table-footer">
              <div class="table-info" id="generator-count">0 groupes</div>
              <div class="pagination">
                <button id="prev-generator-page" disabled><i class="fas fa-chevron-left"></i></button>
                <span id="generator-page-info">Page 1</span>
                <button id="next-generator-page" disabled><i class="fas fa-chevron-right"></i></button>
              </div>
            </div>
          </div>
        </section>

        
        <section id="generator-history-section" class="card">
          <div class="card-header">
            <h2><i class="fas fa-history"></i> Historique des Groupes Électrogènes</h2>
            <div class="filter-actions">
              <select id="generator-filter-type">
                <option value="all">Tous les types</option>
                <option value="generator">Groupes</option>
                <option value="fuel">Carburant</option>
                <option value="maintenance">Maintenance</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div class="timeline" id="generator-history">
            
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <div id="vehicle-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Détails du Véhicule</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body" id="vehicle-details">
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline close-modal">Fermer</button>
      </div>
    </div>
  </div>

  <div id="bike-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="bike-modal-title">Détails de la Moto</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body" id="bike-details">
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline close-modal">Fermer</button>
      </div>
    </div>
  </div>

  <div id="generator-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="generator-modal-title">Détails du Groupe Électrogène</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body" id="generator-details">
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline close-modal">Fermer</button>
      </div>
    </div>
  </div>

  
  <div id="toast" class="toast"></div>

  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script>
    // ============================================
    // CONFIGURATION SUPABASE
    // ============================================
    // REMPLACEZ CES VALEURS AVEC VOS PROPRES CRÉDENTIALS SUPABASE
    const SUPABASE_URL = 'https://cxqyjgfnelzunbbxvaiu.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4cXlqZ2ZuZWx6dW5iYnh2YWl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1ODczOTksImV4cCI6MjA4MDE2MzM5OX0.Gj6HCxcIKv0o4mImP4IH2Thur5lm0QOqVMEKzY1JVxo';
    
    // Initialisation de Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================
    // VARIABLES GLOBALES ET ÉTAT
    // ============================================
    let editingVehicleId = null;
    let editingBikeId = null;
    let editingGeneratorId = null;
    let currentVehiclePage = 1;
    let currentBikePage = 1;
    let currentGeneratorPage = 1;
    const itemsPerPage = 10;

    // ============================================
    // FONCTIONS UTILITAIRES
    // ============================================
    
    // Fonction pour afficher les notifications
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast';
      
      // Ajouter classe de type
      if (type === 'success') {
        toast.style.backgroundColor = '#27ae60';
      } else if (type === 'error') {
        toast.style.backgroundColor = '#e74c3c';
      } else if (type === 'warning') {
        toast.style.backgroundColor = '#f39c12';
      } else {
        toast.style.backgroundColor = '#2c3e50';
      }
      
      toast.classList.add('show');
      
      // Masquer après 3 secondes
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Fonction pour formater la localisation
    function formatLocalisation(localisation) {
      const localisations = {
        'garage': 'Garage',
        'en-circulation': 'En circulation',
        'bureau': 'Bureau',
        'fixe': 'Fixe',
        'mobile': 'Mobile',
        'autre-site': 'Affecté à un autre site temporaire'
      };
      return localisations[localisation] || localisation;
    }

    // Fonction pour formater le statut
    function formatStatut(statut) {
      const statuts = {
        'en service': { class: 'en-service', text: 'En service' },
        'en panne': { class: 'en-panne', text: 'En panne' },
        'en maintenance': { class: 'en-maintenance', text: 'En maintenance' },
        'hors service': { class: 'en-panne', text: 'Hors service' }
      };
      
      const statutInfo = statuts[statut] || { class: '', text: statut };
      return `<span class="bike-status ${statutInfo.class}">${statutInfo.text}</span>`;
    }

    // Fonction pour formater la date
    function formatDate(dateString) {
      if (!dateString) return 'Non spécifié';
      
      // Si la date est déjà formatée, la retourner telle quelle
      if (dateString.includes(' ')) {
        const parts = dateString.split(' ');
        if (parts.length === 3) {
          return `${parts[0]}/${parts[1]}/${parts[2]}`;
        }
      }
      return dateString;
    }

    // ============================================
    // FONCTIONS POUR LES VÉHICULES
    // ============================================
    
    // Récupérer tous les véhicules
    async function getVehicles() {
      try {
        const { data, error } = await supabase
          .from('vehicles')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('Erreur lors de la récupération des véhicules:', error);
        showToast('Erreur lors de la récupération des véhicules', 'error');
        return [];
      }
    }

    // Ajouter un véhicule
    async function addVehicle(vehicleData) {
      try {
        const { data, error } = await supabase
          .from('vehicles')
          .insert([vehicleData])
          .select();
        
        if (error) throw error;
        
        showToast('Véhicule ajouté avec succès', 'success');
        renderVehiclesList();
        clearForm();
        addToHistory('vehicle', 'Ajout', `Véhicule ${vehicleData.immatriculation} ajouté`);
        return data[0];
      } catch (error) {
        console.error('Erreur lors de l\'ajout du véhicule:', error);
        showToast('Erreur lors de l\'ajout du véhicule', 'error');
        return null;
      }
    }

    // Mettre à jour un véhicule
    async function updateVehicle(id, vehicleData) {
      try {
        const { error } = await supabase
          .from('vehicles')
          .update(vehicleData)
          .eq('id', id);
        
        if (error) throw error;
        
        showToast('Véhicule mis à jour avec succès', 'success');
        renderVehiclesList();
        clearForm();
        addToHistory('vehicle', 'Modification', `Véhicule ${vehicleData.immatriculation} modifié`);
        editingVehicleId = null;
      } catch (error) {
        console.error('Erreur lors de la mise à jour du véhicule:', error);
        showToast('Erreur lors de la mise à jour du véhicule', 'error');
      }
    }

    // Supprimer un véhicule
    async function deleteVehicle(id) {
      if (!confirm('Êtes-vous sûr de vouloir supprimer ce véhicule?')) return;
      
      try {
        // Récupérer les informations du véhicule avant suppression
        const { data: vehicle } = await supabase
          .from('vehicles')
          .select('immatriculation')
          .eq('id', id)
          .single();
        
        const { error } = await supabase
          .from('vehicles')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        showToast('Véhicule supprimé avec succès', 'success');
        renderVehiclesList();
        if (vehicle) {
          addToHistory('vehicle', 'Suppression', `Véhicule ${vehicle.immatriculation} supprimé`);
        }
      } catch (error) {
        console.error('Erreur lors de la suppression du véhicule:', error);
        showToast('Erreur lors de la suppression du véhicule', 'error');
      }
    }

    // Afficher la liste des véhicules
    async function renderVehiclesList() {
      const vehicles = await getVehicles();
      const searchTerm = document.getElementById('search-vehicule').value.toLowerCase();
      const tbody = document.getElementById('liste-vehicules');
      const countElement = document.getElementById('vehicule-count');
      
      // Filtrer les véhicules
      const filteredVehicles = vehicles.filter(vehicle => 
        vehicle.immatriculation.toLowerCase().includes(searchTerm) ||
        vehicle.marque.toLowerCase().includes(searchTerm) ||
        vehicle.type.toLowerCase().includes(searchTerm)
      );
      
      // Pagination
      const totalPages = Math.ceil(filteredVehicles.length / itemsPerPage);
      const startIndex = (currentVehiclePage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedVehicles = filteredVehicles.slice(startIndex, endIndex);
      
      // Mettre à jour les informations de pagination
      document.getElementById('prev-page').disabled = currentVehiclePage <= 1;
      document.getElementById('next-page').disabled = currentVehiclePage >= totalPages;
      document.getElementById('page-info').textContent = `Page ${currentVehiclePage} sur ${totalPages}`;
      
      // Générer le HTML
      let html = '';
      
      if (paginatedVehicles.length === 0) {
        html = `<tr><td colspan="6" class="text-center">Aucun véhicule trouvé</td></tr>`;
      } else {
        paginatedVehicles.forEach(vehicle => {
          html += `
            <tr>
              <td>${vehicle.immatriculation}</td>
              <td>${vehicle.marque}</td>
              <td>${vehicle.type}</td>
              <td>${formatStatut(vehicle.statut)}</td>
              <td><span class="localisation-status ${vehicle.localisation}">${formatLocalisation(vehicle.localisation)}</span></td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="editVehicle('${vehicle.id}')">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline" onclick="viewVehicleDetails('${vehicle.id}')">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline" onclick="deleteVehicle('${vehicle.id}')">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });
      }
      
      tbody.innerHTML = html;
      countElement.textContent = `${filteredVehicles.length} véhicule(s)`;
      
      // Mettre à jour les dropdowns
      populateVehicleDropdown();
    }

    // Modifier un véhicule
    async function editVehicle(id) {
      try {
        const { data, error } = await supabase
          .from('vehicles')
          .select('*')
          .eq('id', id)
          .single();
        
        if (error) throw error;
        
        // Remplir le formulaire
        document.getElementById('immatriculation').value = data.immatriculation || '';
        document.getElementById('marque').value = data.marque || '';
        document.getElementById('type').value = data.type || '';
        document.getElementById('date_circulation').value = data.date_circulation || '';
        document.getElementById('statut').value = data.statut || 'en service';
        document.getElementById('localisation').value = data.localisation || 'garage';
        document.getElementById('chauffeur').value = data.chauffeur || '';
        document.getElementById('observations').value = data.observations || '';
        document.getElementById('departement').value = data.departement || '';
        document.getElementById('destination').value = data.destination || '';
        document.getElementById('motif_deplacement').value = data.motif_deplacement || '';
        document.getElementById('km_avant').value = data.km_avant || '';
        document.getElementById('km_apres').value = data.km_apres || '';
        document.getElementById('km_parcouru').value = data.km_parcouru || '';
        
        // Marquer comme édition
        editingVehicleId = id;
        document.getElementById('vehicule-form').dataset.editingId = id;
        document.getElementById('clear-form').textContent = 'Annuler édition';
        
        // Faire défiler vers le formulaire
        document.getElementById('form-section').scrollIntoView({ behavior: 'smooth' });
        
      } catch (error) {
        console.error('Erreur lors de la récupération du véhicule:', error);
        showToast('Erreur lors de la récupération du véhicule', 'error');
      }
    }

    // Voir les détails d'un véhicule
    async function viewVehicleDetails(id) {
      try {
        const { data, error } = await supabase
          .from('vehicles')
          .select('*')
          .eq('id', id)
          .single();
        
        if (error) throw error;
        
        // Générer le HTML des détails
        let html = `
          <div class="detail-item">
            <span class="detail-label">Immatriculation:</span>
            <span class="detail-value">${data.immatriculation}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Marque/Modèle:</span>
            <span class="detail-value">${data.marque}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Type:</span>
            <span class="detail-value">${data.type}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Date de mise en circulation:</span>
            <span class="detail-value">${formatDate(data.date_circulation)}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Statut:</span>
            <span class="detail-value">${formatStatut(data.statut)}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Localisation:</span>
            <span class="detail-value">${formatLocalisation(data.localisation)}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Facteur assigné:</span>
            <span class="detail-value">${data.chauffeur || 'Non assigné'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Département:</span>
            <span class="detail-value">${data.departement || 'Non spécifié'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Destination:</span>
            <span class="detail-value">${data.destination || 'Non spécifiée'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Motif du déplacement:</span>
            <span class="detail-value">${data.motif_deplacement || 'Non spécifié'}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Kilométrage parcouru:</span>
            <span class="detail-value">${data.km_parcouru || 0} km</span>
          </div>
        `;
        
        if (data.observations) {
          html += `
            <div class="detail-item">
              <span class="detail-label">Observations:</span>
              <span class="detail-value">${data.observations}</span>
            </div>
          `;
        }
        
        document.getElementById('vehicle-details').innerHTML = html;
        document.getElementById('modal-title').textContent = `Détails - ${data.immatriculation}`;
        document.getElementById('vehicle-modal').classList.add('show');
        
      } catch (error) {
        console.error('Erreur lors de la récupération des détails:', error);
        showToast('Erreur lors de la récupération des détails', 'error');
      }
    }

    // Vider le formulaire véhicule
    function clearForm() {
      document.getElementById('vehicule-form').reset();
      editingVehicleId = null;
      delete document.getElementById('vehicule-form').dataset.editingId;
      document.getElementById('clear-form').textContent = 'Nouveau';
      document.getElementById('km_parcouru').value = '';
    }

    // Remplir les dropdowns des véhicules
    async function populateVehicleDropdown() {
      const vehicles = await getVehicles();
      const carburantDropdown = document.getElementById('carburant_vehicule');
      const maintenanceDropdown = document.getElementById('vehicle_maintenance_vehicule');
      
      let carburantOptions = '<option value="">Sélectionner un véhicule...</option>';
      let maintenanceOptions = '<option value="">Sélectionner un véhicule...</option>';
      
      vehicles.forEach(vehicle => {
        carburantOptions += `<option value="${vehicle.id}">${vehicle.immatriculation} - ${vehicle.marque}</option>`;
        maintenanceOptions += `<option value="${vehicle.id}">${vehicle.immatriculation} - ${vehicle.marque}</option>`;
      });
      
      carburantDropdown.innerHTML = carburantOptions;
      maintenanceDropdown.innerHTML = maintenanceOptions;
    }

    // ============================================
    // FONCTIONS POUR LES MOTOS
    // ============================================
    
    // Récupérer toutes les motos
    async function getBikes() {
      try {
        const { data, error } = await supabase
          .from('motos')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('Erreur lors de la récupération des motos:', error);
        showToast('Erreur lors de la récupération des motos', 'error');
        return [];
      }
    }

    // Ajouter une moto
    async function addBike(bikeData) {
      try {
        const { data, error } = await supabase
          .from('motos')
          .insert([bikeData])
          .select();
        
        if (error) throw error;
        
        showToast('Moto ajoutée avec succès', 'success');
        renderBikesList();
        clearBikeForm();
        addToHistory('bike', 'Ajout', `Moto ${bikeData.immatriculation} ajoutée`);
        return data[0];
      } catch (error) {
        console.error('Erreur lors de l\'ajout de la moto:', error);
        showToast('Erreur lors de l\'ajout de la moto', 'error');
        return null;
      }
    }

    // Mettre à jour une moto
    async function updateBike(id, bikeData) {
      try {
        const { error } = await supabase
          .from('motos')
          .update(bikeData)
          .eq('id', id);
        
        if (error) throw error;
        
        showToast('Moto mise à jour avec succès', 'success');
        renderBikesList();
        clearBikeForm();
        addToHistory('bike', 'Modification', `Moto ${bikeData.immatriculation} modifiée`);
        editingBikeId = null;
      } catch (error) {
        console.error('Erreur lors de la mise à jour de la moto:', error);
        showToast('Erreur lors de la mise à jour de la moto', 'error');
      }
    }

    // Afficher la liste des motos
    async function renderBikesList() {
      const bikes = await getBikes();
      const searchTerm = document.getElementById('search-bike').value.toLowerCase();
      const tbody = document.getElementById('liste-bikes');
      const countElement = document.getElementById('bike-count');
      
      // Filtrer les motos
      const filteredBikes = bikes.filter(bike => 
        bike.immatriculation.toLowerCase().includes(searchTerm) ||
        bike.marque.toLowerCase().includes(searchTerm) ||
        bike.type.toLowerCase().includes(searchTerm)
      );
      
      // Pagination
      const totalPages = Math.ceil(filteredBikes.length / itemsPerPage);
      const startIndex = (currentBikePage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedBikes = filteredBikes.slice(startIndex, endIndex);
      
      // Mettre à jour les informations de pagination
      document.getElementById('prev-bike-page').disabled = currentBikePage <= 1;
      document.getElementById('next-bike-page').disabled = currentBikePage >= totalPages;
      document.getElementById('bike-page-info').textContent = `Page ${currentBikePage} sur ${totalPages}`;
      
      // Générer le HTML
      let html = '';
      
      if (paginatedBikes.length === 0) {
        html = `<tr><td colspan="6" class="text-center">Aucune moto trouvée</td></tr>`;
      } else {
        paginatedBikes.forEach(bike => {
          html += `
            <tr>
              <td>${bike.immatriculation}</td>
              <td>${bike.marque}</td>
              <td>${bike.type}</td>
              <td>${formatStatut(bike.statut)}</td>
              <td><span class="localisation-status ${bike.localisation}">${formatLocalisation(bike.localisation)}</span></td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="editBike('${bike.id}')">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline" onclick="viewBikeDetails('${bike.id}')">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline" onclick="deleteBike('${bike.id}')">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });
      }
      
      tbody.innerHTML = html;
      countElement.textContent = `${filteredBikes.length} moto(s)`;
      
      // Mettre à jour les dropdowns
      populateBikeDropdown();
    }

    // Remplir les dropdowns des motos
    async function populateBikeDropdown() {
      const bikes = await getBikes();
      const carburantDropdown = document.getElementById('bike_carburant_moto');
      const maintenanceDropdown = document.getElementById('maintenance_bike');
      
      let carburantOptions = '<option value="">Sélectionner une moto...</option>';
      let maintenanceOptions = '<option value="">Sélectionner une moto...</option>';
      
      bikes.forEach(bike => {
        carburantOptions += `<option value="${bike.id}">${bike.immatriculation} - ${bike.marque}</option>`;
        maintenanceOptions += `<option value="${bike.id}">${bike.immatriculation} - ${bike.marque}</option>`;
      });
      
      carburantDropdown.innerHTML = carburantOptions;
      maintenanceDropdown.innerHTML = maintenanceOptions;
    }

    // ============================================
    // FONCTIONS POUR LES GROUPES ÉLECTROGÈNES
    // ============================================
    
    // Récupérer tous les groupes électrogènes
    async function getGenerators() {
      try {
        const { data, error } = await supabase
          .from('groupes_electrogenes')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        return data || [];
      } catch (error) {
        console.error('Erreur lors de la récupération des groupes:', error);
        showToast('Erreur lors de la récupération des groupes', 'error');
        return [];
      }
    }

    // Ajouter un groupe électrogène
    async function addGenerator(generatorData) {
      try {
        const { data, error } = await supabase
          .from('groupes_electrogenes')
          .insert([generatorData])
          .select();
        
        if (error) throw error;
        
        showToast('Groupe électrogène ajouté avec succès', 'success');
        renderGeneratorsList();
        clearGeneratorForm();
        addToHistory('generator', 'Ajout', `Groupe ${generatorData.numero_inventaire} ajouté`);
        return data[0];
      } catch (error) {
        console.error('Erreur lors de l\'ajout du groupe:', error);
        showToast('Erreur lors de l\'ajout du groupe', 'error');
        return null;
      }
    }

    // Afficher la liste des groupes électrogènes
    async function renderGeneratorsList() {
      const generators = await getGenerators();
      const searchTerm = document.getElementById('search-generator').value.toLowerCase();
      const tbody = document.getElementById('liste-generators');
      const countElement = document.getElementById('generator-count');
      
      // Filtrer les groupes
      const filteredGenerators = generators.filter(generator => 
        generator.numero_inventaire.toLowerCase().includes(searchTerm) ||
        generator.marque.toLowerCase().includes(searchTerm) ||
        generator.type.toLowerCase().includes(searchTerm)
      );
      
      // Pagination
      const totalPages = Math.ceil(filteredGenerators.length / itemsPerPage);
      const startIndex = (currentGeneratorPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedGenerators = filteredGenerators.slice(startIndex, endIndex);
      
      // Mettre à jour les informations de pagination
      document.getElementById('prev-generator-page').disabled = currentGeneratorPage <= 1;
      document.getElementById('next-generator-page').disabled = currentGeneratorPage >= totalPages;
      document.getElementById('generator-page-info').textContent = `Page ${currentGeneratorPage} sur ${totalPages}`;
      
      // Générer le HTML
      let html = '';
      
      if (paginatedGenerators.length === 0) {
        html = `<tr><td colspan="7" class="text-center">Aucun groupe électrogène trouvé</td></tr>`;
      } else {
        paginatedGenerators.forEach(generator => {
          html += `
            <tr>
              <td>${generator.numero_inventaire}</td>
              <td>${generator.marque}</td>
              <td>${generator.puissance} kVA</td>
              <td>${generator.type}</td>
              <td>${formatStatut(generator.statut)}</td>
              <td><span class="localisation-status ${generator.localisation}">${formatLocalisation(generator.localisation)}</span></td>
              <td>
                <button class="btn btn-sm btn-outline" onclick="editGenerator('${generator.id}')">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline" onclick="viewGeneratorDetails('${generator.id}')">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline" onclick="deleteGenerator('${generator.id}')">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });
      }
      
      tbody.innerHTML = html;
      countElement.textContent = `${filteredGenerators.length} groupe(s)`;
      
      // Mettre à jour les dropdowns
      populateGeneratorDropdown();
    }

    // Remplir les dropdowns des groupes électrogènes
    async function populateGeneratorDropdown() {
      const generators = await getGenerators();
      const carburantDropdown = document.getElementById('generator_carburant_groupe');
      const maintenanceDropdown = document.getElementById('generator_maintenance_groupe');
      
      let carburantOptions = '<option value="">Sélectionner un groupe...</option>';
      let maintenanceOptions = '<option value="">Sélectionner un groupe...</option>';
      
      generators.forEach(generator => {
        carburantOptions += `<option value="${generator.id}">${generator.numero_inventaire} - ${generator.marque}</option>`;
        maintenanceOptions += `<option value="${generator.id}">${generator.numero_inventaire} - ${generator.marque}</option>`;
      });
      
      carburantDropdown.innerHTML = carburantOptions;
      maintenanceDropdown.innerHTML = maintenanceOptions;
    }

    // ============================================
    // GESTION DE L'HISTORIQUE
    // ============================================
    
    // Ajouter une entrée à l'historique
    function addToHistory(type, action, description) {
      const history = JSON.parse(localStorage.getItem('fleet_history') || '[]');
      const entry = {
        id: Date.now(),
        type: type,
        action: action,
        description: description,
        date: new Date().toISOString()
      };
      
      history.unshift(entry);
      if (history.length > 50) history.pop(); // Garder seulement les 50 dernières entrées
      
      localStorage.setItem('fleet_history', JSON.stringify(history));
      renderHistory();
    }

    // Afficher l'historique
    function renderHistory() {
      const history = JSON.parse(localStorage.getItem('fleet_history') || '[]');
      const filterType = document.getElementById('filter-type').value;
      const timeline = document.getElementById('historique');
      
      let filteredHistory = history;
      if (filterType !== 'all') {
        filteredHistory = history.filter(entry => entry.type === filterType);
      }
      
      let html = '';
      
      if (filteredHistory.length === 0) {
        html = '<p class="text-center">Aucun historique disponible</p>';
      } else {
        filteredHistory.forEach(entry => {
          const date = new Date(entry.date);
          const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
          
          html += `
            <div class="timeline-item">
              <div class="timeline-date">${formattedDate}</div>
              <div class="timeline-content">
                <strong>${entry.action}</strong> - ${entry.description}
              </div>
            </div>
          `;
        });
      }
      
      timeline.innerHTML = html;
    }

    // ============================================
    // CALCULS AUTOMATIQUES
    // ============================================
    
    function setupAutoCalculations() {
      // Calcul kilométrage parcouru pour les véhicules
      const kmAvant = document.getElementById('km_avant');
      const kmApres = document.getElementById('km_apres');
      const kmParcouru = document.getElementById('km_parcouru');
      
      function calculateKMParcouru() {
        const avant = parseInt(kmAvant.value) || 0;
        const apres = parseInt(kmApres.value) || 0;
        kmParcouru.value = Math.max(0, apres - avant);
      }
      
      if (kmAvant && kmApres && kmParcouru) {
        kmAvant.addEventListener('input', calculateKMParcouru);
        kmApres.addEventListener('input', calculateKMParcouru);
      }
      
      // Calcul kilométrage pour le carburant des véhicules
      const carburantKmDepart = document.getElementById('carburant_km_depart');
      const carburantKmArrivee = document.getElementById('carburant_km_arrivee');
      const carburantKmParcouru = document.getElementById('carburant_km_parcouru');
      
      function calculateCarburantKMParcouru() {
        const depart = parseInt(carburantKmDepart.value) || 0;
        const arrivee = parseInt(carburantKmArrivee.value) || 0;
        carburantKmParcouru.value = Math.max(0, arrivee - depart);
      }
      
      if (carburantKmDepart && carburantKmArrivee && carburantKmParcouru) {
        carburantKmDepart.addEventListener('input', calculateCarburantKMParcouru);
        carburantKmArrivee.addEventListener('input', calculateCarburantKMParcouru);
      }
      
      // Calcul coût total pour le carburant des véhicules
      const carburantLitres = document.getElementById('carburant_litres');
      const carburantPrix = document.getElementById('carburant_prix_unitaire');
      const carburantCout = document.getElementById('carburant_cout');
      
      function calculateCarburantCout() {
        const litres = parseFloat(carburantLitres.value) || 0;
        const prix = parseFloat(carburantPrix.value) || 0;
        carburantCout.value = (litres * prix).toFixed(2);
      }
      
      if (carburantLitres && carburantPrix && carburantCout) {
        carburantLitres.addEventListener('input', calculateCarburantCout);
        carburantPrix.addEventListener('input', calculateCarburantCout);
      }
      
      // Calcul temps de fonctionnement pour les groupes électrogènes
      const heureMarche = document.getElementById('generator_carburant_heure_marche');
      const heureArret = document.getElementById('generator_carburant_heure_arret');
      const tempsFonctionnement = document.getElementById('generator_carburant_temps_fonctionnement');
      
      function calculateTempsFonctionnement() {
        if (heureMarche.value && heureArret.value) {
          const [startHours, startMinutes] = heureMarche.value.split(':').map(Number);
          const [endHours, endMinutes] = heureArret.value.split(':').map(Number);
          
          let totalMinutes = (endHours * 60 + endMinutes) - (startHours * 60 + startMinutes);
          
          // Gérer le cas où l'heure d'arrêt est le lendemain
          if (totalMinutes < 0) {
            totalMinutes += 24 * 60;
          }
          
          const hours = Math.floor(totalMinutes / 60);
          const minutes = totalMinutes % 60;
          
          tempsFonctionnement.value = `${hours}h ${minutes}min`;
        }
      }
      
      if (heureMarche && heureArret && tempsFonctionnement) {
        heureMarche.addEventListener('input', calculateTempsFonctionnement);
        heureArret.addEventListener('input', calculateTempsFonctionnement);
      }
      
      // Calcul coût total pour les groupes électrogènes
      const generatorQuantite = document.getElementById('generator_carburant_quantite_ravitailler');
      const generatorPrix = document.getElementById('generator_carburant_prix_unitaire');
      const generatorCout = document.getElementById('generator_carburant_cout');
      
      function calculateGeneratorCout() {
        const quantite = parseFloat(generatorQuantite.value) || 0;
        const prix = parseFloat(generatorPrix.value) || 0;
        generatorCout.value = (quantite * prix).toFixed(2);
      }
      
      if (generatorQuantite && generatorPrix && generatorCout) {
        generatorQuantite.addEventListener('input', calculateGeneratorCout);
        generatorPrix.addEventListener('input', calculateGeneratorCout);
      }
    }

    // ============================================
    // GESTION DES ÉVÉNEMENTS
    // ============================================
    
    // Initialisation de l'application
    function initApp() {
      // Restaurer le thème
      const savedTheme = localStorage.getItem('fleet_theme');
      if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
        const themeButton = document.getElementById('toggle-theme');
        themeButton.innerHTML = savedTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
      }
      
      // Gestion des onglets
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          tab.classList.add('active');
          const tabId = tab.getAttribute('data-tab') + '-tab';
          document.getElementById(tabId).classList.add('active');
        });
      });
      
      // Bouton thème
      document.getElementById('toggle-theme').addEventListener('click', function() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? '' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        this.innerHTML = newTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        localStorage.setItem('fleet_theme', newTheme);
      });
      
      // Formulaire véhicule
      document.getElementById('vehicule-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const vehicleData = {
          immatriculation: document.getElementById('immatriculation').value,
          marque: document.getElementById('marque').value,
          type: document.getElementById('type').value,
          date_circulation: document.getElementById('date_circulation').value,
          statut: document.getElementById('statut').value,
          localisation: document.getElementById('localisation').value,
          chauffeur: document.getElementById('chauffeur').value,
          observations: document.getElementById('observations').value,
          departement: document.getElementById('departement').value,
          destination: document.getElementById('destination').value,
          motif_deplacement: document.getElementById('motif_deplacement').value,
          km_avant: parseInt(document.getElementById('km_avant').value) || 0,
          km_apres: parseInt(document.getElementById('km_apres').value) || 0,
          km_parcouru: parseInt(document.getElementById('km_parcouru').value) || 0
        };
        
        if (editingVehicleId) {
          await updateVehicle(editingVehicleId, vehicleData);
        } else {
          await addVehicle(vehicleData);
        }
      });
      
      // Bouton nouveau véhicule
      document.getElementById('clear-form').addEventListener('click', clearForm);
      
      // Bouton annuler édition
      document.getElementById('cancel-edit').addEventListener('click', clearForm);
      
      // Recherche véhicules
      document.getElementById('search-vehicule').addEventListener('input', renderVehiclesList);
      
      // Pagination véhicules
      document.getElementById('prev-page').addEventListener('click', () => {
        if (currentVehiclePage > 1) {
          currentVehiclePage--;
          renderVehiclesList();
        }
      });
      
      document.getElementById('next-page').addEventListener('click', () => {
        currentVehiclePage++;
        renderVehiclesList();
      });
      
      // Filtre historique
      document.getElementById('filter-type').addEventListener('change', renderHistory);
      
      // Formulaire carburant véhicule
      document.getElementById('carburant-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const carburantData = {
          vehicle_id: document.getElementById('carburant_vehicule').value,
          date: document.getElementById('carburant_date').value,
          km_depart: parseInt(document.getElementById('carburant_km_depart').value) || 0,
          km_arrivee: parseInt(document.getElementById('carburant_km_arrivee').value) || 0,
          km_parcouru: parseInt(document.getElementById('carburant_km_parcouru').value) || 0,
          litres: parseFloat(document.getElementById('carburant_litres').value) || 0,
          consommation_100km: parseFloat(document.getElementById('carburant_consommation_100km').value) || 0,
          prix_unitaire: parseFloat(document.getElementById('carburant_prix_unitaire').value) || 0,
          type_carburant: document.getElementById('carburant_type').value,
          cout_total: parseFloat(document.getElementById('carburant_cout').value) || 0
        };
        
        try {
          const { data, error } = await supabase
            .from('carburant')
            .insert([carburantData])
            .select();
          
          if (error) throw error;
          
          showToast('Ravitaillement enregistré avec succès', 'success');
          document.getElementById('carburant-form').reset();
          document.getElementById('carburant_km_parcouru').value = '';
          document.getElementById('carburant_cout').value = '';
          
          // Récupérer les informations du véhicule pour l'historique
          const { data: vehicle } = await supabase
            .from('vehicles')
            .select('immatriculation')
            .eq('id', carburantData.vehicle_id)
            .single();
          
          if (vehicle) {
            addToHistory('fuel', 'Ravitaillement', `Carburant ajouté pour ${vehicle.immatriculation}`);
          }
          
        } catch (error) {
          console.error('Erreur lors de l\'ajout du ravitaillement:', error);
          showToast('Erreur lors de l\'ajout du ravitaillement', 'error');
        }
      });
      
      // Formulaire maintenance véhicule
      document.getElementById('vehicle-maintenance-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const maintenanceData = {
          vehicle_id: document.getElementById('vehicle_maintenance_vehicule').value,
          date: document.getElementById('vehicle_maintenance_date').value,
          type: document.getElementById('vehicle_maintenance_type').value,
          cout: parseFloat(document.getElementById('vehicle_maintenance_cout').value) || 0,
          description: document.getElementById('vehicle_maintenance_description').value
        };
        
        try {
          const { data, error } = await supabase
            .from('maintenance')
            .insert([maintenanceData])
            .select();
          
          if (error) throw error;
          
          showToast('Maintenance enregistrée avec succès', 'success');
          document.getElementById('vehicle-maintenance-form').reset();
          
          // Récupérer les informations du véhicule pour l'historique
          const { data: vehicle } = await supabase
            .from('vehicles')
            .select('immatriculation')
            .eq('id', maintenanceData.vehicle_id)
            .single();
          
          if (vehicle) {
            addToHistory('maintenance', 'Maintenance', `Maintenance ajoutée pour ${vehicle.immatriculation}`);
          }
          
        } catch (error) {
          console.error('Erreur lors de l\'ajout de la maintenance:', error);
          showToast('Erreur lors de l\'ajout de la maintenance', 'error');
        }
      });
      
      // Export Excel
      document.getElementById('export-excel').addEventListener('click', async () => {
        const vehicles = await getVehicles();
        
        // Formater les données pour Excel
        const data = vehicles.map(vehicle => [
          vehicle.immatriculation,
          vehicle.marque,
          vehicle.type,
          formatDate(vehicle.date_circulation),
          vehicle.statut,
          formatLocalisation(vehicle.localisation),
          vehicle.chauffeur || '',
          vehicle.departement || '',
          vehicle.destination || '',
          vehicle.km_parcouru || 0
        ]);
        
        // Créer le classeur Excel
        const ws = XLSX.utils.aoa_to_sheet([
          ['Immatriculation', 'Marque/Modèle', 'Type', 'Date Circulation', 'Statut', 'Localisation', 'Chauffeur', 'Département', 'Destination', 'Km Parcouru'],
          ...data
        ]);
        
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Véhicules');
        
        // Générer et télécharger
        const today = new Date().toISOString().split('T')[0];
        XLSX.writeFile(wb, `flotte_vehicules_${today}.xlsx`);
        showToast('Export Excel généré avec succès', 'success');
      });
      
      // Modals
      document.querySelectorAll('.close-modal').forEach(button => {
        button.addEventListener('click', function() {
          this.closest('.modal').classList.remove('show');
        });
      });
      
      // Fermer les modals en cliquant à l'extérieur
      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
          if (e.target === this) {
            this.classList.remove('show');
          }
        });
      });
      
      // Initialiser les calculs automatiques
      setupAutoCalculations();
      
      // Rendre les listes initiales
      renderVehiclesList();
      renderBikesList();
      renderGeneratorsList();
      renderHistory();
    }

    // Démarrer l'application quand le DOM est chargé
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>
